import ct from"util";import St from"buffer";import{randomUUID as ze}from"node:crypto";var At=Object.create,ft=Object.defineProperty,kt=Object.getOwnPropertyDescriptor,ht=Object.getOwnPropertyNames,Nt=Object.getPrototypeOf,$t=Object.prototype.hasOwnProperty;var De=(n,u)=>function(){return u||(0,n[ht(n)[0]])((u={exports:{}}).exports,u),u.exports},It=(n,u,o,p)=>{if(u&&typeof u=="object"||typeof u=="function")for(let d of ht(u))!$t.call(n,d)&&d!==o&&ft(n,d,{get:()=>u[d],enumerable:!(p=kt(u,d))||p.enumerable});return n},xt=(n,u,o)=>(o=n!=null?At(Nt(n)):{},It(u||!n||!n.__esModule?ft(o,"default",{value:n,enumerable:!0}):o,n)),lt=De({"node_modules/@avro/types/lib/utils.js"(n,u){"use strict";var o=new v(4096);function p(a){return typeof Buffer.alloc=="function"?Buffer.alloc(a):new Buffer(a)}function d(a,f){return typeof Buffer.from=="function"?Buffer.from(a,f):new Buffer(a,f)}function g(a){return a.charAt(0).toUpperCase()+a.slice(1)}function b(a,f){return a===f?0:a<f?-1:1}function O(a,f){if(typeof a!=typeof f)return!1;switch(typeof a){case"number":case"string":return a===f;case"object":if(a===null||f===null)return a===f;var _,m;if(Array.isArray(a)){if(!Array.isArray(f)||a.length!==f.length)return!1;for(_=0,m=a.length;_<m;_++)if(!O(a[_],f[_]))return!1;return!0}var S=Object.keys(a).sort(),$=Object.keys(f).sort();if(!O(S,$))return!1;for(_=0,m=S.length;_<m;_++){var R=S[_];if(!O(a[R],f[R]))return!1}return!0;default:return!1}}function l(a,f){var _={},m,S;for(m=0;m<a.length;m++)S=a[m],_[f(S)]=S;return _}function T(a,f){var _={},m,S,$;for(m=0,S=a.length;m<S;m++){if($=a[m],f&&($=f($)),_[$])return!0;_[$]=!0}return!1}function F(){var a=arguments.length;if(!a)return!1;var f=arguments[0];if(!f||typeof f.createResolver!="function"||typeof f._createBranchConstructor!="function")return!1;if(a===1)return!0;var _=f.typeName,m;for(m=1;m<a;m++)if(_.indexOf(arguments[m])===0)return!0;return!1}function x(a){var f=a.split(".");return f[f.length-1]}function V(){throw new Error("abstract")}function v(a){this._len=a|0,this._pos=0,this._slab=p(this._len)}v.prototype.alloc=function(a){var f=this._len;return a>f?p(a):(this._pos+a>f&&(this._slab=p(f),this._pos=0),this._slab.slice(this._pos,this._pos+=a))};function s(a,f){if(this.buf=a,this.pos=f|0,this.pos<0)throw new Error("negative offset")}s.prototype.isValid=function(){return this.pos<=this.buf.length},s.prototype.readBoolean=function(){return!!this.buf[this.pos++]},s.prototype.skipBoolean=function(){this.pos++},s.prototype.writeBoolean=function(a){this.buf[this.pos++]=!!a},s.prototype.readInt=s.prototype.readLong=function(){var a=0,f=0,_=this.buf,m,S,$,R;do m=_[this.pos++],S=m&128,a|=(m&127)<<f,f+=7;while(S&&f<28);if(S){$=a,R=268435456;do m=_[this.pos++],$+=(m&127)*R,R*=128;while(m&128);return($%2?-($+1):$)/2}return a>>1^-(a&1)},s.prototype.skipInt=s.prototype.skipLong=function(){for(var a=this.buf;a[this.pos++]&128;);},s.prototype.writeInt=s.prototype.writeLong=function(a){var f=this.buf,_,m;if(a>=-1073741824&&a<1073741824){m=a>=0?a<<1:~a<<1|1;do f[this.pos]=m&127,m>>=7;while(m&&(f[this.pos++]|=128))}else{_=a>=0?a*2:-a*2-1;do f[this.pos]=_&127,_/=128;while(_>=1&&(f[this.pos++]|=128))}this.pos++},s.prototype.readFloat=function(){var a=this.buf,f=this.pos;if(this.pos+=4,!(this.pos>a.length))return this.buf.readFloatLE(f)},s.prototype.skipFloat=function(){this.pos+=4},s.prototype.writeFloat=function(a){var f=this.buf,_=this.pos;if(this.pos+=4,!(this.pos>f.length))return this.buf.writeFloatLE(a,_)},s.prototype.readDouble=function(){var a=this.buf,f=this.pos;if(this.pos+=8,!(this.pos>a.length))return this.buf.readDoubleLE(f)},s.prototype.skipDouble=function(){this.pos+=8},s.prototype.writeDouble=function(a){var f=this.buf,_=this.pos;if(this.pos+=8,!(this.pos>f.length))return this.buf.writeDoubleLE(a,_)},s.prototype.readFixed=function(a){var f=this.pos;if(this.pos+=a,!(this.pos>this.buf.length)){var _=o.alloc(a);return this.buf.copy(_,0,f,f+a),_}},s.prototype.skipFixed=function(a){this.pos+=a},s.prototype.writeFixed=function(a,f){f=f||a.length;var _=this.pos;this.pos+=f,!(this.pos>this.buf.length)&&a.copy(this.buf,_,0,f)},s.prototype.readBytes=function(){return this.readFixed(this.readLong())},s.prototype.skipBytes=function(){var a=this.readLong();this.pos+=a},s.prototype.writeBytes=function(a){var f=a.length;this.writeLong(f),this.writeFixed(a,f)},typeof Buffer.prototype.utf8Slice=="function"?s.prototype.readString=function(){var a=this.readLong(),f=this.pos,_=this.buf;if(this.pos+=a,!(this.pos>_.length))return this.buf.utf8Slice(f,f+a)}:s.prototype.readString=function(){var a=this.readLong(),f=this.pos,_=this.buf;if(this.pos+=a,!(this.pos>_.length))return this.buf.slice(f,f+a).toString()},s.prototype.skipString=function(){var a=this.readLong();this.pos+=a},s.prototype.writeString=function(a){var f=Buffer.byteLength(a),_=this.buf;this.writeLong(f);var m=this.pos;if(this.pos+=f,!(this.pos>_.length))if(f>64)this._writeUtf8(a,f);else{var S,$,R,B;for(S=0,$=f;S<$;S++)R=a.charCodeAt(S),R<128?_[m++]=R:R<2048?(_[m++]=R>>6|192,_[m++]=R&63|128):(R&64512)===55296&&((B=a.charCodeAt(S+1))&64512)===56320?(R=65536+((R&1023)<<10)+(B&1023),S++,_[m++]=R>>18|240,_[m++]=R>>12&63|128,_[m++]=R>>6&63|128,_[m++]=R&63|128):(_[m++]=R>>12|224,_[m++]=R>>6&63|128,_[m++]=R&63|128)}},typeof Buffer.prototype.utf8Write=="function"?s.prototype._writeUtf8=function(a,f){this.buf.utf8Write(a,this.pos-f,f)}:s.prototype._writeUtf8=function(a,f){this.buf.write(a,this.pos-f,f,"utf8")},typeof Buffer.prototype.latin1Write=="function"?s.prototype.writeBinary=function(a,f){var _=this.pos;this.pos+=f,!(this.pos>this.buf.length)&&this.buf.latin1Write(a,_,f)}:typeof Buffer.prototype.binaryWrite=="function"?s.prototype.writeBinary=function(a,f){var _=this.pos;this.pos+=f,!(this.pos>this.buf.length)&&this.buf.binaryWrite(a,_,f)}:s.prototype.writeBinary=function(a,f){var _=this.pos;this.pos+=f,!(this.pos>this.buf.length)&&this.buf.write(a,_,f,"binary")},s.prototype.matchBoolean=function(a){return this.buf[this.pos++]-a.buf[a.pos++]},s.prototype.matchInt=s.prototype.matchLong=function(a){var f=this.readLong(),_=a.readLong();return f===_?0:f<_?-1:1},s.prototype.matchFloat=function(a){var f=this.readFloat(),_=a.readFloat();return f===_?0:f<_?-1:1},s.prototype.matchDouble=function(a){var f=this.readDouble(),_=a.readDouble();return f===_?0:f<_?-1:1},s.prototype.matchFixed=function(a,f){return this.readFixed(f).compare(a.readFixed(f))},s.prototype.matchBytes=s.prototype.matchString=function(a){var f=this.readLong(),_=this.pos;this.pos+=f;var m=a.readLong(),S=a.pos;a.pos+=m;var $=this.buf.slice(_,this.pos),R=a.buf.slice(S,a.pos);return $.compare(R)},s.prototype.unpackLongBytes=function(){var a=p(8),f=0,_=0,m=6,S=this.buf,$,R;for($=S[this.pos++],R=$&1,a.fill(0),f|=($&127)>>1;$&128;)$=S[this.pos++],f|=($&127)<<m,m+=7,m>=8&&(m-=8,a[_++]=f,f>>=8);return a[_]=f,R&&w(a,8),a},s.prototype.packLongBytes=function(a){var f=(a[7]&128)>>7,_=this.buf,m=1,S=0,$=3,R;f?(w(a,8),R=1):R=0;for(var B=[a.readUIntLE(0,3),a.readUIntLE(3,3),a.readUIntLE(6,2)];$&&!B[--$];);for(;S<$;)for(R|=B[S++]<<m,m+=24;m>7;)_[this.pos++]=R&127|128,R>>=7,m-=7;R|=B[$]<<m;do _[this.pos]=R&127,R>>=7;while(R&&(_[this.pos++]|=128));this.pos++,f&&w(a,8)};function w(a,f){for(;f--;)a[f]=~a[f]}u.exports={Tap:s,abstractFunction:V,bufferFrom:d,capitalize:g,compare:b,hasDuplicates:T,isType:F,jsonEquals:O,newBuffer:p,toMap:l,unqualifyName:x}}}),jt=De({"node_modules/@avro/types/lib/values.js"(n,u){"use strict";var o=lt(),p=ct,d=p.format;function g(v,s,w){return l("FROM_JSON",v,s,w)}function b(v,s,w){return l("FROM_DEFAULT_JSON",v,s,w)}function O(v,s,w){return l("TO_JSON",v,s,w)}function l(v,s,w,a){return new x(v,a).clone(s,w,[]).build(w)}function T(){this.value=void 0,this.errors=[]}T.prototype.isOk=function(){return!this.errors.length},T.prototype.build=function(v){if(!this.errors.length)return this.value;var s=[],w,a;for(w=0,a=this.errors.length;w<a;w++)s.push(d("	%s",this.errors[w].message));var f=d(`%s error(s) when expecting %s:
%s`,this.errors.length,F(v),s.join(`
`)),_=new Error(f);throw _.code="ERR_AVRO_INCOMPATIBLE_VALUE",_.type=v,_.errors=this.errors,_},T.prototype.addError=function(v,s,w,a){var f=F(w),_=d("$%s has %s but %s: %j",V(a),f,v,s),m=new Error(_);m.value=s,m.expectedType=w,m.path=a,this.errors.push(m)},T.prototype.copyErrorsFrom=function(v){v.errors.length&&(this.errors=this.errors.concat(v.errors))};function F(v){if(o.isType(v,"union")){var s=v.types.map(function(w){return w.branchName});return d("a type among %s",s.join(", "))}else return o.isType(v,"logical")?d("type %s (%s)",v.typeName,v.branchName):d("type %s",v.branchName)}function x(v,s){if(s=s||{},this._mode=v,this._allowUndeclaredFields=!!s.allowUndeclaredFields,this._omitDefaultValues=!!s.omitDefaultValues,this._omitDefaultValues&&this._mode!=="TO_JSON")throw new Error("invalid cloner options")}x.prototype.clone=function(v,s,w){if(!o.isType(s))throw new Error(d("not a type: %s",s));switch(s.typeName){case"array":return this._onArray(v,s,w);case"map":return this._onMap(v,s,w);case"error":case"record":return this._onRecord(v,s,w);case"union:unwrapped":case"union:wrapped":return this._onUnion(v,s,w);default:return o.isType(s,"logical")?this._onLogical(v,s,w):this._onPrimitive(v,s,w)}},x.prototype._onLogical=function(v,s,w){var a=new T,f;if(this._mode==="TO_JSON")try{if(a.value=s._toValue(v),a.value===void 0)return a.addError("logical type encoding failed",v,s,w),a}catch(_){return f=d("logical type encoding failed (%s)",_.message),a.addError(f,v,s,w),a}else a.value=v;if(a=this.clone(a.value,s.underlyingType,w),!a.isOk())return a;if(this._mode!=="TO_JSON")try{a.value=s._fromValue(a.value)}catch(_){f=d("logical type decoding failed (%s)",_.message),a.addError(f,v,s,w)}return a},x.prototype._onPrimitive=function(v,s,w){var a=new T,f=o.isType(s,"bytes","fixed"),_=o.isType(s,"abstract:long"),m=v;if(f&&this._mode!=="TO_JSON"){if(typeof v!="string")return a.addError("is not a string",v,s,w),a;m=o.bufferFrom(v,"binary")}return _&&this._mode==="TO_JSON"&&s.isValid(m)?a.value=s._toJSON(m):_&&typeof m=="number"?a.value=s._fromJSON(m):s.isValid(m)?o.isType(s,"abstract:long")?this._mode==="TO_JSON"?a.value=s._toJSON(m):a.value=s._fromJSON(m):a.value=f?o.bufferFrom(m):m:a.addError("invalid value",v,s,w),this._mode==="TO_JSON"&&f&&(a.value=a.value.toString("binary")),a},x.prototype._onRecord=function(v,s,w){var a=new T,f;if(!v||typeof v!="object")return a.addError("is not a valid object",v,s,w),a;var _,m;if(!this._allowUndeclaredFields){var S=[],$=Object.keys(v),R;for(_=0,m=$.length;_<m;_++)R=$[_],s.field(R)||S.push(R);S.length&&(f=d("contains %s undeclared field(s) (%s)",S.length,S.join(", ")),a.addError(f,v,s,w))}var B=[],G=[void 0],M,Q,K,Z,ee,Y;for(_=0,m=s.fields.length;_<m;_++)M=s.fields[_],Q=v[M.name],Z=w.slice(),Z.push(M.name),Y=M.defaultValue(),K=void 0,Q===void 0&&Y===void 0?B.push(M.name):Q===void 0?this._mode==="TO_JSON"&&!this._omitDefaultValues&&(K=this.clone(Y,M.type,Z).value):(ee=this.clone(Q,M.type,Z),a.copyErrorsFrom(ee),K=ee.value,this._omitDefaultValues&&ee.isOk()&&Y!==void 0&&!M.type.compare(Q,Y,{allowMaps:!0})&&(K=void 0)),G.push(K);if(B.length&&(f=d("is missing %s field(s) (%s)",B.length,B.join()),a.addError(f,v,s,w)),a.isOk())if(this._mode==="TO_JSON")for(a.value={},_=0,m=s.fields.length;_<m;_++)K=G[_+1],K!==void 0&&(a.value[s.fields[_].name]=K);else{var W=s.recordConstructor;a.value=new(W.bind.apply(W,G))}return a},x.prototype._onArray=function(v,s,w){var a=new T;if(!Array.isArray(v))return a.addError("is not an array",v,s,w),a;var f=[],_,m,S;for(_=0,m=v.length;_<m;_++){S=v[_];var $=w.slice();$.push(_);var R=this.clone(S,s.itemsType,$);a.copyErrorsFrom(R),a.isOk()&&f.push(R.value)}return a.isOk()&&(a.value=f),a},x.prototype._onMap=function(v,s,w){var a=new T;if(!v||typeof v!="object")return a.addError("is not a valid object",v,s,w),a;var f={},_=Object.keys(v).sort(),m,S;for(m=0,S=_.length;m<S;m++){var $=_[m],R=v[$],B=w.slice();B.push($);var G=this.clone(R,s.valuesType,B);a.copyErrorsFrom(G),a.isOk()&&(f[$]=G.value)}return a.isOk()&&(a.value=f),a},x.prototype._onUnion=function(v,s,w){var a=s.typeName==="union:wrapped",f=new T;if(v===null){var _,m;for(_=0,m=s.types.length;_<m;_++)if(s.types[_].typeName==="null")return f.value=null,f;return f.addError("is null",v,s,w),f}var S;if(this._mode==="FROM_DEFAULT_JSON"){if(S=s.types[0],S.typeName==="null")return f.addError("does not match first (null)",v,s,w),f;v=S.wrap(v)}else if(this._mode==="TO_JSON"&&!a){if(S=s.branchType(v),!S)return f.addError("is not a valid branch",v,s,w),f;v=S.wrap(v)}if(typeof v!="object")return f.addError("is not an object",v,s,w),f;var $=Object.keys(v),R;if($.length!==1)return R=d("has %s keys (%s)",$.length,$),f.addError(R,v,s,w),f;var B=$[0];if(S=s.type(B),!S)return R=d("contains an unknown branch (%s)",B),f.addError(R,v,s,w),f;var G=w.slice();G.push(B);var M=this.clone(v[B],S,G);return f.copyErrorsFrom(M),M.isOk()&&(this._mode==="TO_JSON"?(f.value={},f.value[S.branchName]=M.value):a?f.value=S.wrap(M.value):f.value=M.value),f};function V(v){var s=[],w,a,f;for(w=0,a=v.length;w<a;w++)f=v[w],isNaN(f)?s.push("."+f):s.push("["+f+"]");return s.join("")}u.exports={fromJSON:g,fromDefaultJSON:b,toJSON:O}}}),Lt=De({"node_modules/@avro/types/lib/types.js"(n,u){"use strict";var o=lt(),p=jt(),d=St,g=ct,b=o.Tap,O=g.debuglog("avro:types"),l=g.format,T={array:Y,boolean:f,bytes:B,double:$,enum:K,error:W,fixed:Z,float:S,int:_,long:m,map:ee,null:a,record:W,string:R},F=/^[A-Za-z_][A-Za-z0-9_]*$/,x=new b(new d.SlowBuffer(1024)),V=null,v=[];function s(e,t,r){var i;if(V?(i=V,v.push([V,this]),V=null):i=this,this.name=void 0,this.aliases=void 0,this.doc=e&&e.doc?""+e.doc:void 0,e){var c=e.name,h=e.namespace===void 0?r&&r.namespace:e.namespace;if(c!==void 0){if(c=Ue(c,h),me(c))throw new Error(l("cannot rename primitive type: %j",c));var y=t&&t.registry;if(y){if(y[c]!==void 0)throw new Error(l("duplicate type name: %s",c));y[c]=i}}else if(t&&t.noAnonymousTypes)throw new Error(l("missing name property in schema: %j",e));this.name=c,this.aliases=e.aliases?e.aliases.map(function(E){return Ue(E,h)}):[]}}s.forSchema=function(e,t,r){t=t||{},t.registry=t.registry||{},r=r||se.forOptions(t);var i=function(A){switch(A===!0?A="always":A===!1?A="never":A===void 0?A="auto":typeof A=="string"&&(A=A.toLowerCase()),A){case"always":return Q;case"never":return M;case"auto":return;default:throw new Error(l("invalid wrap unions option: %j",A))}}(t.wrapUnions);if(e===null)throw new Error('invalid type: null (did you mean "null"?)');if(o.isType(e))return e;var c;if(t.typeHook&&(c=t.typeHook(e,t,r))){if(!o.isType(c))throw new Error(l("invalid typehook return value: %j",c));return c}if(typeof e=="string"){if(e=Ue(e,r.namespace),c=t.registry[e],c)return c;if(me(e))return t.registry[e]=s.forSchema({type:e},t);throw new Error(l("undefined type name: %s",e))}if(e.logicalType&&t.logicalTypes&&!V){var h=t.logicalTypes[e.logicalType];if(h){var y={};Object.keys(t.registry).forEach(function(A){y[A]=t.registry[A]});try{return O("instantiating logical type for %s",e.logicalType),new h(e,t)}catch(A){if(O("failed to instantiate logical type for %s",e.logicalType),t.assertLogicalTypes)throw A;V=null,t.registry=y}}}if(Array.isArray(e)){var E=V;V=null;var N=e.map(function(A,U){return s.forSchema(A,t,r.child(U))});i||(i=wt(N)?Q:M),V=E,c=new i(N,t)}else c=function(A){var U=T[A];if(U===void 0)throw new Error(l("unknown type: %j",A));return new U(e,t,r)}(e.type);return c},s.forValue=function(e,t,r){if(t=t||{},r=r||se.forOptions(t),t.emptyArrayType=t.emptyArrayType||s.forSchema({type:"array",items:"null"}),t.valueHook){var i=t.valueHook(e,t,r);if(i!==void 0){if(!o.isType(i))throw new Error(l("invalid value hook return value: %j",i));return i}}switch(typeof e){case"string":return s.forSchema("string",t,r);case"boolean":return s.forSchema("boolean",t,r);case"number":return(e|0)===e?s.forSchema("int",t,r):Math.abs(e)<9007199254740991?s.forSchema("float",t,r):s.forSchema("double",t,r);case"object":if(e===null)return s.forSchema("null",t,r);if(Array.isArray(e))return e.length?s.forSchema({type:"array",items:s.forTypes(e.map(function(h,y){return s.forValue(h,t,r.child(y))}),t,r.child("*"))},t,r):t.emptyArrayType;if(Buffer.isBuffer(e))return s.forSchema("bytes",t,r);var c=Object.keys(e);return c.some(function(h){return!Te(h)})?s.forSchema({type:"map",values:s.forTypes(c.map(function(h){return s.forValue(e[h],t,r.child(h))}),t,r.child("*"))},t,r):s.forSchema({type:"record",fields:c.map(function(h){return{name:h,type:s.forValue(e[h],t,r.child(h))}})},t,r);default:throw new Error(l("cannot infer type from: %j",e))}},s.forTypes=function(e,t,r){if(!e.length)throw new Error("no types to combine");if(e.length===1)return e[0];t=t||{},r=r||se.forOptions(t);var i=[],c=0,h=!0;if(e.forEach(function(z){switch(z.typeName){case"union:unwrapped":h=!1,i=i.concat(z.types);break;case"union:wrapped":c++,i=i.concat(z.types);break;case"null":i.push(z);break;default:h=!1,i.push(z)}}),c){if(!h)throw new Error("cannot combine wrapped union");var y={};i.forEach(function(z){var P=z.branchName,j=y[P];if(!j)y[P]=z;else if(!z.equals(j))throw new Error("inconsistent branch type")});var E=t.wrapUnions,N;t.wrapUnions=!0;try{N=s.forSchema(Object.keys(y).map(function(z){return y[z]}),t,r)}catch(z){throw t.wrapUnions=E,z}return t.wrapUnions=E,N}var A={};i.forEach(function(z){var P=$e(z),j=A[P];j||(A[P]=j=[]),j.push(z)});var U=Object.keys(A),q=U.map(function(z){var P=A[z];if(P.length===1)return P[0];switch(z){case"null":case"boolean":return P[0];case"number":return bt(P);case"string":return Et(P,t,r);case"buffer":return Ot(P,t,r);case"array":return P=P.filter(function(j){return j!==t.emptyArrayType}),P.length?s.forSchema({type:"array",items:s.forTypes(P.map(function(j){return j.itemsType}),t,r.child("*"))},t,r):t.emptyArrayType;default:return Tt(P,t,r)}});return q.length===1?q[0]:s.forSchema(q,t,r)},s.isType=o.isType,s.__reset=function(e){O("resetting type buffer to %d",e),x.buf=new d.SlowBuffer(e)},Object.defineProperty(s.prototype,"branchName",{enumerable:!0,get:function(){var e=s.isType(this,"logical")?this.underlyingType:this;return e.name?e.name:o.isType(e,"abstract")?e._concreteTypeName:o.isType(e,"union")?void 0:e.typeName}}),s.prototype.compare=o.abstractFunction,s.prototype.binaryCompare=function(e,t){return this._match(new b(e),new b(t))},s.prototype.createResolver=function(e,t){if(!o.isType(e))throw new Error(l("not a type: %j",e));if(!o.isType(this,"union","logical")&&o.isType(e,"logical"))return this.createResolver(e.underlyingType,t);t=t||{},t.registry=t.registry||{};var r,i;if(o.isType(this,"record","error")&&o.isType(e,"record","error")&&(i=this.name+":"+e.name,r=t.registry[i],r))return r;if(r=new Ke(e,this),i&&(t.registry[i]=r),o.isType(e,"union")){var c=e.types.map(function(h){return this.createResolver(h,t)},this);r._read=function(h){var y=h.readLong(),E=c[y];if(E===void 0)throw new Error(l("invalid union index: %s",y));return c[y]._read(h)}}else this._update(r,e,t);if(!r._read)throw new Error(l("cannot read %s as %s",e,this));return Object.freeze(r)},s.prototype.binaryDecode=function(e,t,r){var i=new b(e),c=Je(this,i,t,r);if(!i.isValid())throw new Error("truncated buffer");if(!r&&i.pos<e.length)throw new Error("trailing data");return c},s.prototype.binaryEncode=function(e){x.pos=0,this._write(x,e);var t=o.newBuffer(x.pos);return x.isValid()?x.buf.copy(t,0,0,x.pos):this._write(new b(t),e),t},s.prototype.binaryDecodeAt=function(e,t,r){var i=new b(e,t),c=Je(this,i,r);return i.isValid()?{value:c,offset:i.pos}:{value:void 0,offset:-1}},s.prototype.binaryEncodeAt=function(e,t,r){var i=new b(t,r);return this._write(i,e),i.isValid()?i.pos:t.length-i.pos},s.prototype.jsonDecode=function(e,t,r){var i={allowUndeclaredFields:r};if(!t)return p.fromJSON(e,this,i);var c=t._writerType,h=p.fromJSON(e,c,i);return this.binaryDecode(c.binaryEncode(h),t)},s.prototype.jsonEncode=function(e,t){return p.toJSON(e,this,t)},s.prototype.clone=function(e){return this.binaryDecode(this.binaryEncode(e))},s.prototype.wrap=function(e){var t=this._branchConstructor;return t===null?null:new t(e)},s.prototype.checkValid=function(e,t){t={allowUndeclaredFields:t&&t.allowUndeclaredFields},!this.isValid(e,t)&&p.toJSON(e,this,t)},s.prototype.isValid=function(e,t){var r=!(t&&t.allowUndeclaredFields)|0,i=t&&t.errorHook,c,h;return i&&(h=[],c=function(y,E){i.call(this,h.slice(),y,E,e)}),this._check(e,r,c,h)},s.prototype.equals=function(e){return o.isType(e)&&o.jsonEquals(this.schema(),e.schema())},s.prototype.schema=function(e){return this._attrs({exportAttrs:!!(e&&e.exportAttrs),noDeref:!!(e&&e.noDeref)})},s.prototype.toJSON=function(){return this.schema({exportAttrs:!0})},s.prototype.toString=function(){return l("<%s>",Qe(this.typeName))},s.prototype._attrs=function(e){e.derefed=e.derefed||{};var t=this.name;if(t!==void 0){if(e.noDeref||e.derefed[t])return t;e.derefed[t]=!0}var r={};this.name!==void 0&&(r.name=t),r.type=this.typeName;var i=this._deref(r,e);return i!==void 0&&(r=i),e.exportAttrs&&(this.aliases&&this.aliases.length&&(r.aliases=this.aliases),this.doc!==void 0&&(r.doc=this.doc)),r},s.prototype._createBranchConstructor=function(){var e=this.branchName;if(e==="null")return null;var t=~e.indexOf(".")?"this['"+e+"']":"this."+e,r="return function Branch$(val) { "+t+" = val; };",i=new Function(r)(),c=new Function("return '<Branch$ "+e+">'");Object.defineProperty(i.prototype,"toString",{get:function(){return c}});var h=this;i.type=h,Object.defineProperty(i.prototype,"type",{get:function(){return h}});var y=new Function("return "+t+";");return Object.defineProperty(i.prototype,"unwrap",{get:function(){return y}}),i},s.prototype._peek=function(e){var t=e.pos,r=this._read(e);return e.pos=t,r},s.prototype._check=o.abstractFunction,s.prototype._deref=o.abstractFunction,s.prototype._match=o.abstractFunction,s.prototype._read=o.abstractFunction,s.prototype._skip=o.abstractFunction,s.prototype._update=o.abstractFunction,s.prototype._write=o.abstractFunction,s.prototype.decode=s.prototype.binaryDecodeAt,s.prototype.encode=s.prototype.binaryEncodeAt,s.prototype.fromBuffer=s.prototype.binaryDecode,s.prototype.toBuffer=s.prototype.binaryEncode,s.prototype.compareBuffers=s.prototype.binaryCompare;function w(e){s.call(this),this._branchConstructor=this._createBranchConstructor(),e||Object.freeze(this)}g.inherits(w,s),w.prototype._update=function(e,t){t.typeName===this.typeName&&(e._read=this._read)},w.prototype._deref=function(){return this.typeName},w.prototype.compare=o.compare;function a(){w.call(this)}g.inherits(a,w),a.prototype._check=function(e,t,r){var i=e===null;return!i&&r&&r(e,this),i},a.prototype._read=function(){return null},a.prototype._skip=function(){},a.prototype._write=function(e,t){t!==null&&X(t,this)},a.prototype._match=function(){return 0},a.prototype.compare=a.prototype._match,a.prototype.typeName="null";function f(){w.call(this)}g.inherits(f,w),f.prototype._check=function(e,t,r){var i=typeof e=="boolean";return!i&&r&&r(e,this),i},f.prototype._read=function(e){return e.readBoolean()},f.prototype._skip=function(e){e.skipBoolean()},f.prototype._write=function(e,t){typeof t!="boolean"&&X(t,this),e.writeBoolean(t)},f.prototype._match=function(e,t){return e.matchBoolean(t)},f.prototype.typeName="boolean";function _(){w.call(this)}g.inherits(_,w),_.prototype._check=function(e,t,r){var i=e===(e|0);return!i&&r&&r(e,this),i},_.prototype._read=function(e){return e.readInt()},_.prototype._skip=function(e){e.skipInt()},_.prototype._write=function(e,t){t!==(t|0)&&X(t,this),e.writeInt(t)},_.prototype._match=function(e,t){return e.matchInt(t)},_.prototype.typeName="int";function m(){w.call(this)}g.inherits(m,w),m.prototype._check=function(e,t,r){var i=typeof e=="number"&&e%1===0&&Be(e);return!i&&r&&r(e,this),i},m.prototype._read=function(e){var t=e.readLong();if(!Be(t))throw new Error("potential precision loss");return t},m.prototype._skip=function(e){e.skipLong()},m.prototype._write=function(e,t){(typeof t!="number"||t%1||!Be(t))&&X(t,this),e.writeLong(t)},m.prototype._match=function(e,t){return e.matchLong(t)},m.prototype._update=function(e,t){switch(t.typeName){case"int":e._read=t._read;break;case"abstract:long":case"long":e._read=this._read}},m.prototype.typeName="long",m.__with=function(e,t){e=e||{};var r={toBuffer:"_toBuffer",fromBuffer:"_fromBuffer",fromJSON:"_fromJSON",toJSON:"_toJSON",isValid:"_isValid",compare:"compare"},i=new ie(t);return Object.keys(r).forEach(function(c){if(e[c]===void 0)throw new Error(l("missing method implementation: %s",c));i[r[c]]=e[c]}),Object.freeze(i)};function S(){w.call(this)}g.inherits(S,w),S.prototype._check=function(e,t,r){var i=typeof e=="number";return!i&&r&&r(e,this),i},S.prototype._read=function(e){return e.readFloat()},S.prototype._skip=function(e){e.skipFloat()},S.prototype._write=function(e,t){typeof t!="number"&&X(t,this),e.writeFloat(t)},S.prototype._match=function(e,t){return e.matchFloat(t)},S.prototype._update=function(e,t){switch(t.typeName){case"float":case"int":e._read=t._read;break;case"abstract:long":case"long":e._read=function(r){return r.readLong()}}},S.prototype.typeName="float";function $(){w.call(this)}g.inherits($,w),$.prototype._check=function(e,t,r){var i=typeof e=="number";return!i&&r&&r(e,this),i},$.prototype._read=function(e){return e.readDouble()},$.prototype._skip=function(e){e.skipDouble()},$.prototype._write=function(e,t){typeof t!="number"&&X(t,this),e.writeDouble(t)},$.prototype._match=function(e,t){return e.matchDouble(t)},$.prototype._update=function(e,t){switch(t.typeName){case"double":case"float":case"int":e._read=t._read;break;case"abstract:long":case"long":e._read=function(r){return r.readLong()}}},$.prototype.typeName="double";function R(){w.call(this)}g.inherits(R,w),R.prototype._check=function(e,t,r){var i=typeof e=="string";return!i&&r&&r(e,this),i},R.prototype._read=function(e){return e.readString()},R.prototype._skip=function(e){e.skipString()},R.prototype._write=function(e,t){typeof t!="string"&&X(t,this),e.writeString(t)},R.prototype._match=function(e,t){return e.matchString(t)},R.prototype._update=function(e,t){switch(t.typeName){case"bytes":case"string":e._read=this._read}},R.prototype.typeName="string";function B(){w.call(this)}g.inherits(B,w),B.prototype._check=function(e,t,r){var i=Buffer.isBuffer(e);return!i&&r&&r(e,this),i},B.prototype._read=function(e){return e.readBytes()},B.prototype._skip=function(e){e.skipBytes()},B.prototype._write=function(e,t){Buffer.isBuffer(t)||X(t,this),e.writeBytes(t)},B.prototype._match=function(e,t){return e.matchBytes(t)},B.prototype._update=R.prototype._update,B.prototype.compare=Buffer.compare,B.prototype.typeName="bytes";function G(e,t,r){if(s.call(this),!Array.isArray(e))throw new Error(l("non-array union schema: %j",e));if(!e.length)throw new Error("empty union");this.types=Object.freeze(e.map(function(i){return s.forSchema(i,t,r)})),this._branchIndices={},this.types.forEach(function(i,c){if(o.isType(i,"union"))throw new Error("unions cannot be directly nested");var h=i.branchName;if(this._branchIndices[h]!==void 0)throw new Error(l("duplicate union branch name: %j",h));this._branchIndices[h]=c},this)}g.inherits(G,s),G.prototype._branchConstructor=function(){throw new Error("unions cannot be directly wrapped")},G.prototype._skip=function(e){this.types[e.readLong()]._skip(e)},G.prototype._match=function(e,t){var r=e.readLong(),i=t.readLong();return r===i?this.types[r]._match(e,t):r<i?-1:1},G.prototype._deref=function(e,t){return this.types.map(function(r){return r._attrs(t)})},G.prototype.type=function(e){var t=this._branchIndices[e];if(t!==void 0)return this.types[t]};function M(e,t){G.call(this,e,t),this._dynamicBranches=null,this._bucketIndices={},this.types.forEach(function(r,i){if(o.isType(r,"abstract","logical"))this._dynamicBranches||(this._dynamicBranches=[]),this._dynamicBranches.push({index:i,type:r});else{var c=$e(r);if(this._bucketIndices[c]!==void 0)throw new Error(l("ambiguous unwrapped union: %j",this));this._bucketIndices[c]=i}},this),Object.freeze(this)}g.inherits(M,G),M.prototype._getIndex=function(e){var t=this._bucketIndices[Xe(e)];return this._dynamicBranches&&(t=this._getBranchIndex(e,t)),t},M.prototype._getBranchIndex=function(e,t){var r=this._dynamicBranches,i,c,h;for(i=0,c=r.length;i<c;i++)if(h=r[i],h.type._check(e))if(t===void 0)t=h.index;else throw new Error("ambiguous conversion");return t},M.prototype._check=function(e,t,r,i){var c=this._getIndex(e),h=c!==void 0;return h?this.types[c]._check(e,t,r,i):(r&&r(e,this),h)},M.prototype._read=function(e){var t=e.readLong(),r=this.types[t];if(r)return r._read(e);throw new Error(l("invalid union index: %s",t))},M.prototype._write=function(e,t){var r=this._getIndex(t);r===void 0&&X(t,this),e.writeLong(r),t!==null&&this.types[r]._write(e,t)},M.prototype._update=function(e,t,r){var i,c,h;for(i=0,c=this.types.length;i<c;i++){try{h=this.types[i].createResolver(t,r)}catch{continue}e._read=function(y){return h._read(y)};return}},M.prototype.branchType=function(e){var t=this._getIndex(e);return t===void 0?void 0:this.types[t]},M.prototype.branchValue=function(e){return e},M.prototype.compare=function(e,t,r){var i=this._getIndex(e),c=this._getIndex(t);if(i===void 0)X(e,this);else if(c===void 0)X(t,this);else return i===c?this.types[i].compare(e,t,r):o.compare(i,c)},M.prototype.typeName="union:unwrapped";function Q(e,t){G.call(this,e,t),Object.freeze(this)}g.inherits(Q,G),Q.prototype._check=function(e,t,r,i){var c=!1;if(e===null)c=this._branchIndices.null!==void 0;else if(typeof e=="object"){var h=Object.keys(e);if(h.length===1){var y=h[0],E=this._branchIndices[y];if(E!==void 0)return r?(i.push(y),c=this.types[E]._check(e[y],t,r,i),i.pop(),c):this.types[E]._check(e[y],t)}}return!c&&r&&r(e,this),c},Q.prototype._read=function(e){var t=this.types[e.readLong()];if(!t)throw new Error(l("invalid union index"));var r=t._branchConstructor;return r===null?null:new r(t._read(e))},Q.prototype._write=function(e,t){var r,i,c;t===null?(r=this._branchIndices.null,r===void 0&&X(t,this),e.writeLong(r)):(i=Object.keys(t),i.length===1&&(c=i[0],r=this._branchIndices[c]),r===void 0&&X(t,this),e.writeLong(r),this.types[r]._write(e,t[c]))},Q.prototype._update=function(e,t,r){var i,c,h,y;for(i=0,c=this.types.length;i<c;i++){try{h=this.types[i].createResolver(t,r)}catch{continue}y=this.types[i]._branchConstructor,y?e._read=function(E){return new y(h._read(E))}:e._read=function(){return null};return}},Q.prototype.branchType=function(e){if(typeof e=="object"){var t=e===null?"null":Object.keys(e)[0],r=this._branchIndices[t];return r===void 0?void 0:this.types[r]}},Q.prototype.branchValue=function(e){return e===null?null:e[Object.keys(e)[0]]},Q.prototype.compare=function(e,t,r){var i=e===null?"null":Object.keys(e)[0],c=t===null?"null":Object.keys(t)[0],h=this._branchIndices[i];return i===c?i==="null"?0:this.types[h].compare(e[i],t[i],r):o.compare(h,this._branchIndices[c])},Q.prototype.typeName="union:wrapped";function K(e,t,r){if(s.call(this,e,t,r),!Array.isArray(e.symbols)||!e.symbols.length)throw new Error(l("invalid enum symbols: %j",e.symbols));this.symbols=Object.freeze(e.symbols.slice()),this._indices={},this.symbols.forEach(function(i,c){if(!Te(i))throw new Error(l("invalid %s symbol: %j",this,i));if(this._indices[i]!==void 0)throw new Error(l("duplicate %s symbol: %j",this,i));this._indices[i]=c},this),this._branchConstructor=this._createBranchConstructor(),Object.freeze(this)}g.inherits(K,s),K.prototype._check=function(e,t,r){var i=this._indices[e]!==void 0;return!i&&r&&r(e,this),i},K.prototype._read=function(e){var t=e.readLong(),r=this.symbols[t];if(r===void 0)throw new Error(l("invalid %s enum index: %s",this.name,t));return r},K.prototype._skip=function(e){e.skipLong()},K.prototype._write=function(e,t){var r=this._indices[t];r===void 0&&X(t,this),e.writeLong(r)},K.prototype._match=function(e,t){return e.matchLong(t)},K.prototype.compare=function(e,t){return o.compare(this._indices[e],this._indices[t])},K.prototype._update=function(e,t){var r=this.symbols;t.typeName==="enum"&&(!t.name||~Ne(this).indexOf(t.name))&&t.symbols.every(function(i){return~r.indexOf(i)})&&(e.symbols=t.symbols,e._read=t._read)},K.prototype._deref=function(e){e.symbols=this.symbols},K.prototype.typeName="enum";function Z(e,t,r){if(s.call(this,e,t,r),e.size!==(e.size|0)||e.size<0)throw new Error(l("invalid %s size",this.branchName));this.size=e.size|0,this._branchConstructor=this._createBranchConstructor(),Object.freeze(this)}g.inherits(Z,s),Z.prototype._check=function(e,t,r){var i=Buffer.isBuffer(e)&&e.length===this.size;return!i&&r&&r(e,this),i},Z.prototype._read=function(e){return e.readFixed(this.size)},Z.prototype._skip=function(e){e.skipFixed(this.size)},Z.prototype._write=function(e,t){(!Buffer.isBuffer(t)||t.length!==this.size)&&X(t,this),e.writeFixed(t,this.size)},Z.prototype._match=function(e,t){return e.matchFixed(t,this.size)},Z.prototype.compare=Buffer.compare,Z.prototype._update=function(e,t){t.typeName==="fixed"&&this.size===t.size&&(!t.name||~Ne(this).indexOf(t.name))&&(e.size=this.size,e._read=this._read)},Z.prototype._deref=function(e){e.size=this.size},Z.prototype.typeName="fixed";function ee(e,t,r){if(s.call(this),!e.values)throw new Error(l("missing map values: %j",e));r=r||se.forOptions(t),this.valuesType=s.forSchema(e.values,t,r.child("*")),this._branchConstructor=this._createBranchConstructor(),Object.freeze(this)}g.inherits(ee,s),ee.prototype._check=function(e,t,r,i){if(!e||typeof e!="object"||Array.isArray(e))return r&&r(e,this),!1;var c=Object.keys(e),h=!0,y,E,N,A;if(r){for(N=i.length,i.push(""),y=0,E=c.length;y<E;y++)A=i[N]=c[y],this.valuesType._check(e[A],t,r,i)||(h=!1);i.pop()}else for(y=0,E=c.length;y<E;y++)if(!this.valuesType._check(e[c[y]],t))return!1;return h},ee.prototype._read=function(e){for(var t=this.valuesType,r={},i;i=Pe(e);)for(;i--;){var c=e.readString();r[c]=t._read(e)}return r},ee.prototype._skip=function(e){for(var t=this.valuesType,r,i;i=e.readLong();)if(i<0)r=e.readLong(),e.pos+=r;else for(;i--;)e.skipString(),t._skip(e)},ee.prototype._write=function(e,t){(!t||typeof t!="object"||Array.isArray(t))&&X(t,this);var r=this.valuesType,i=Object.keys(t),c=i.length,h,y;if(c)for(e.writeLong(c),h=0;h<c;h++)y=i[h],e.writeString(y),r._write(e,t[y]);e.writeLong(0)},ee.prototype._match=function(){throw new Error("maps cannot be compared")},ee.prototype._update=function(e,t,r){t.typeName==="map"&&(e.valuesType=this.valuesType.createResolver(t.valuesType,r),e._read=this._read)},ee.prototype.compare=function(e,t,r){if(!r||!r.allowMaps)return this._match();var i=Object.keys(e).sort(),c=Object.keys(t).sort(),h=i.length,y=c.length,E,N,A,U;for(E=0,N=Math.min(h,y);E<N;E++)if(A=i[E],(U=o.compare(A,c[E]))||(U=this.valuesType.compare(e[A],t[A],r)))return U;return o.compare(h,y)},ee.prototype.typeName="map",ee.prototype._deref=function(e,t){e.values=this.valuesType._attrs(t)};function Y(e,t,r){if(s.call(this),!e.items)throw new Error(l("missing array items: %j",e));r=r||se.forOptions(t),this.itemsType=s.forSchema(e.items,t,r.child("*")),this._branchConstructor=this._createBranchConstructor(),Object.freeze(this)}g.inherits(Y,s),Y.prototype._check=function(e,t,r,i){if(!Array.isArray(e))return r&&r(e,this),!1;var c=!0,h,y,E;if(r){for(E=i.length,i.push(""),h=0,y=e.length;h<y;h++)i[E]=""+h,this.itemsType._check(e[h],t,r,i)||(c=!1);i.pop()}else for(h=0,y=e.length;h<y;h++)if(!this.itemsType._check(e[h],t))return!1;return c},Y.prototype._read=function(e){for(var t=this.itemsType,r=[],i;i=e.readLong();)for(i<0&&(i=-i,e.skipLong());i--;)r.push(t._read(e));return r},Y.prototype._skip=function(e){for(var t,r;r=e.readLong();)if(r<0)t=e.readLong(),e.pos+=t;else for(;r--;)this.itemsType._skip(e)},Y.prototype._write=function(e,t){Array.isArray(t)||X(t,this);var r=t.length,i;if(r)for(e.writeLong(r),i=0;i<r;i++)this.itemsType._write(e,t[i]);e.writeLong(0)},Y.prototype._match=function(e,t){for(var r=e.readLong(),i=t.readLong(),c;r&&i;){if(c=this.itemsType._match(e,t),c)return c;--r||(r=Pe(e)),--i||(i=Pe(t))}return o.compare(r,i)},Y.prototype._update=function(e,t,r){t.typeName==="array"&&(e.itemsType=this.itemsType.createResolver(t.itemsType,r),e._read=this._read)},Y.prototype._deref=function(e,t){e.items=this.itemsType._attrs(t)},Y.prototype.compare=function(e,t,r){var i=e.length,c=t.length,h,y,E;for(h=0,y=Math.min(i,c);h<y;h++)if(E=this.itemsType.compare(e[h],t[h],r))return E;return o.compare(i,c)},Y.prototype.typeName="array";function W(e,t,r){if(t=t||{},r=r?r.clone():se.forOptions(t),e.namespace!==void 0)r.namespace=e.namespace;else if(e.name){var i=/^(.*)\.[^.]+$/.exec(e.name);i&&(r.namespace=i[1])}if(s.call(this,e,t,r),!Array.isArray(e.fields))throw new Error(l("non-array record fields: %j",e.fields));if(o.hasDuplicates(e.fields,function(c){return c.name}))throw new Error(l("duplicate field name: %j",e.fields));this._fieldsByName={},this.fields=Object.freeze(e.fields.map(function(c){var h=new Fe(c,t,r);return this._fieldsByName[h.name]=h,h},this)),this._sizeProp=t.recordSizeProperty,this._isError=e.type==="error",this._branchConstructor=this._createBranchConstructor(),this.recordConstructor=this._createConstructor(t.errorStackTraces,t.omitRecordMethods),this._read=this._createReader(),this._skip=this._createSkipper(),this._write=this._createWriter(),this._check=this._createChecker(),Object.freeze(this)}g.inherits(W,s),W.prototype._getConstructorName=function(){return this.name?o.capitalize(o.unqualifyName(this.name)):this._isError?"Error$":"Record$"},W.prototype._createConstructor=function(e,t){var r=[],i=[],c=[],h="",y,E,N,A,U,q,z;for(y=0,E=this.fields.length;y<E;y++)N=this.fields[y],U=N.defaultValue,q=U()!==void 0,A=N.name,e&&this._isError&&A==="stack"&&o.isType(N.type,"string")&&!q&&(z=N),i.push("v"+y),h+="  ",q?(h+="if (v"+y+" === undefined) { ",h+="this."+A+" = d"+c.length+"(); ",h+="} else { this."+A+" = v"+y+`; }
`,r.push("d"+c.length),c.push(U)):h+="this."+A+" = v"+y+`;
`;z&&(h+="  if (this.stack === undefined) { ",typeof Error.captureStackTrace=="function"?h+="Error.captureStackTrace(this, this.constructor);":h+="this.stack = Error().stack;",h+=` }
`);var P="return function "+this._getConstructorName()+"(";P+=i.join()+`) {
`+h+"};";var j=new Function(r.join(),P).apply(void 0,c);if(t)return j;var D=this;return j.type=D,j.fromBuffer=function(){return D.binaryDecode.apply(D,arguments)},j.fromObject=function(){return D.jsonDecode.apply(D,arguments)},this._isError&&(g.inherits(j,Error),j.prototype.name=D.name),Object.defineProperty(j.prototype,"clone",{get:function(){return le}}),Object.defineProperty(j.prototype,"compare",{get:function(){return ue}}),Object.defineProperty(j.prototype,"checkValid",{get:function(){return ce}}),Object.defineProperty(j.prototype,"isValid",{get:function(){return J}}),Object.defineProperty(j.prototype,"toBuffer",{get:function(){return fe}}),Object.defineProperty(j.prototype,"toObject",{get:function(){return _e}}),Object.defineProperty(j.prototype,"toString",{get:function(){return Ie}}),Object.defineProperty(j.prototype,"wrap",{get:function(){return pe}}),j;function le(){return D.clone(this)}function ue(H,xe){return D.compare(this,H,xe)}function ce(H){return D.checkValid(this,H)}function J(H){return D.isValid(this,H)}function fe(){return D.binaryEncode(this)}function _e(H){return D.jsonEncode(this,H)}function Ie(){var H;return D._isError?(H=D._getConstructorName(),this.code!==void 0&&(H+=" ["+this.code+"]"),this.message&&(H+=": "+this.message)):H="<"+D._getConstructorName()+">",H}function pe(){return D.wrap(this)}},W.prototype._createChecker=function(){var e=[],t=[],r=this._getConstructorName(),i="return function check"+r+`(v, f, h, p) {
`;if(i+=`  if (
`,i+=`    v === null ||
`,i+=`    typeof v != 'object' ||
`,i+=`    (f && !this._checkFields(v))
`,i+=`  ) {
`,i+=`    if (h) { h(v, this); }
`,i+=`    return false;
`,i+=`  }
`,!this.fields.length)i+=`  return true;
`;else{for(c=0,h=this.fields.length;c<h;c++)y=this.fields[c],e.push("t"+c),t.push(y.type),y.defaultValue()!==void 0&&(i+="  var v"+c+" = v."+y.name+`;
`);i+=`  if (h) {
`,i+=`    var b = 1;
`,i+=`    var j = p.length;
`,i+=`    p.push('');
`;var c,h,y;for(c=0,h=this.fields.length;c<h;c++)y=this.fields[c],i+="    p[j] = '"+y.name+`';
`,i+="    b &= ",y.defaultValue()===void 0?i+="t"+c+"._check(v."+y.name+`, f, h, p);
`:(i+="v"+c+" === undefined || ",i+="t"+c+"._check(v"+c+`, f, h, p);
`);i+=`    p.pop();
`,i+=`    return !!b;
`,i+=`  } else {
    return (
      `,i+=this.fields.map(function(E,N){return E.defaultValue()===void 0?"t"+N+"._check(v."+E.name+", f)":"(v"+N+" === undefined || t"+N+"._check(v"+N+", f))"}).join(` &&
      `),i+=`
    );
  }
`}return i+="};",new Function(e.join(),i).apply(void 0,t)},W.prototype._createReader=function(){var e=[],t=[this.recordConstructor],r,i;for(r=0,i=this.fields.length;r<i;r++)e.push("t"+r),t.push(this.fields[r].type);var c=this._getConstructorName(),h="return function read"+c+`(t) {
  `;return this._sizeProp?(h+=`var p = t.pos;
  var v = new `+c+"(",h+=e.map(function(y){return y+"._read(t)"}).join(", "),h+=`);
  `,h+=`Object.defineProperty(v, s, {value: t.pos-p, writable: true});
`,h+=`  return v;
};`,e.push("s"),t.push(this._sizeProp)):(h+="return new "+c+"(",h+=e.map(function(y){return y+"._read(t)"}).join(", "),h+=`);
};`),e.unshift(c),new Function(e.join(),h).apply(void 0,t)},W.prototype._createSkipper=function(){var e=[],t="return function skip"+this._getConstructorName()+`(t) {
`,r=[],i,c;for(i=0,c=this.fields.length;i<c;i++)e.push("t"+i),r.push(this.fields[i].type),t+="  t"+i+`._skip(t);
`;return t+="}",new Function(e.join(),t).apply(void 0,r)},W.prototype._createWriter=function(){var e=[],t=this._getConstructorName(),r="return function write"+t+`(t, v) {
`,i=[],c,h,y,E;for(c=0,h=this.fields.length;c<h;c++)y=this.fields[c],e.push("t"+c),i.push(y.type),r+="  ",y.defaultValue()===void 0?r+="t"+c+"._write(t, v."+y.name+`);
`:(E=y.type.binaryEncode(y.defaultValue()).toString("binary"),e.push("d"+c),i.push(E),r+="var v"+c+" = v."+y.name+`;
`,r+="if (v"+c+` === undefined) {
`,r+="    t.writeBinary(d"+c+", "+E.length+`);
`,r+=`  } else {
    t`+c+"._write(t, v"+c+`);
  }
`);return r+="}",new Function(e.join(),r).apply(void 0,i)},W.prototype._update=function(e,t,r){if(t.name&&!~Ne(this).indexOf(t.name))throw new Error(l("no alias found for %s",t.name));var i=this.fields,c=t.fields,h=o.toMap(c,function(_e){return _e.name}),y=[],E={},N,A,U,q,z,P,j;for(N=0;N<i.length;N++){for(U=i[N],z=Ne(U),P=[],A=0;A<z.length;A++)q=z[A],h[q]&&P.push(q);if(P.length>1)throw new Error(l("ambiguous aliasing for %s.%s (%s)",t.name,U.name,P));if(P.length)q=P[0],j={resolver:U.type.createResolver(h[q].type,r),name:"_"+U.name},E[q]?E[q].push(j):E[q]=[j],y.push(j.name);else{if(U.defaultValue()===void 0)throw new Error(l("no matching field for default-less %s.%s",t.name,U.name));y.push("undefined")}}var D=-1;for(N=c.length;N&&E[c[--N].name]===void 0;)D=N;var le=this._getConstructorName(),ue=[le],ce=[this.recordConstructor],J="  return function read"+le+`(t, b) {
`,fe;for(this._sizeProp&&(J+=`  var c = 0;
  var p;
`),N=0;N<c.length;N++)if(N===D&&(J+=`  if (!b) {
`),fe=~D&&N>=D?"    ":"  ",U=t.fields[N],q=U.name,E[q]===void 0)ue.push("r"+N),ce.push(U.type),J+=fe+"r"+N+`._skip(t);
`;else{for(A=E[q].length,this._sizeProp&&(J+=fe+`p = t.pos;
`);A--;)ue.push("r"+N+"f"+A),j=E[q][A],ce.push(j.resolver),J+=fe+"var "+j.name+" = ",J+="r"+N+"f"+A+"._"+(A?"peek":"read")+`(t);
`;this._sizeProp&&(J+=fe+`c += t.pos-p;
`)}~D&&(J+=`  }
`),J+="  var v = new "+le+"("+y.join()+`);
`,this._sizeProp&&(J+=`  Object.defineProperty(v, s, {value: c, writable: true});
`,ce.push(this._sizeProp),ue.push("s")),J+=`  return v;
};`,e._read=new Function(ue.join(),J).apply(void 0,ce)},W.prototype._match=function(e,t){var r=this.fields,i,c,h,y,E;for(i=0,c=r.length;i<c;i++)if(h=r[i],y=h._order,E=h.type,y){if(y*=E._match(e,t),y)return y}else E._skip(e),E._skip(t);return 0},W.prototype._checkFields=function(e){var t=Object.keys(e),r,i;for(r=0,i=t.length;r<i;r++)if(!this._fieldsByName[t[r]])return!1;return!0},W.prototype._deref=function(e,t){e.fields=this.fields.map(function(r){var i=r.type,c={name:r.name,type:i._attrs(t)};if(t.exportAttrs){r._defaultValue!==void 0&&(c.default=r._defaultValue);var h=r.order;h!=="ascending"&&(c.order=h);var y=r.aliases;y.length&&(c.aliases=y);var E=r.doc;E!==void 0&&(c.doc=E)}return c})},W.prototype.compare=function(e,t,r){var i=this.fields,c,h,y,E,N,A;for(c=0,h=i.length;c<h;c++)if(y=i[c],E=y.name,N=y._order,A=y.type,N&&(N*=A.compare(e[E],t[E],r),N))return N;return 0},W.prototype.field=function(e){return this._fieldsByName[e]},Object.defineProperty(W.prototype,"typeName",{enumerable:!0,get:function(){return this._isError?"error":"record"}});function re(e,t,r){this._logicalTypeName=e.logicalType,s.call(this),V=this;try{this._underlyingType=s.forSchema(e,t,r)}finally{V=null;var i=v.length;i&&v[i-1][0]===this&&v.pop()}o.isType(this.underlyingType,"union")?this._branchConstructor=this.underlyingType._branchConstructor:this._branchConstructor=this.underlyingType._createBranchConstructor()}g.inherits(re,s),Object.defineProperty(re.prototype,"typeName",{enumerable:!0,get:function(){return"logical:"+this._logicalTypeName}}),Object.defineProperty(re.prototype,"underlyingType",{enumerable:!0,get:function(){if(this._underlyingType)return this._underlyingType;var e,t,r;for(e=0,t=v.length;e<t;e++)if(r=v[e],r[0]===this)return r[1]}}),re.prototype._read=function(e){return this._fromValue(this.underlyingType._read(e))},re.prototype._write=function(e,t){this.underlyingType._write(e,this._toValue(t))},re.prototype._check=function(e,t,r,i){try{var c=this._toValue(e)}catch{}return c===void 0?(r&&r(e,this),!1):this.underlyingType._check(c,t,r,i)},re.prototype._update=function(e,t,r){var i=this._resolve(t,r),c,h;Array.isArray(i)?(c=i[0],h=i[1]):(c=i,h=t),c&&(e._read=function(y){return c(h._read(y))})},re.prototype.compare=function(e,t,r){var i=this._toValue(e),c=this._toValue(t);return this.underlyingType.compare(i,c,r)},re.prototype._deref=function(e,t){var r=this.underlyingType,i=r.name!==void 0&&t.derefed[r.name];return e=r._attrs(t),!i&&t.exportAttrs&&(typeof e=="string"&&(e={type:e}),e.logicalType=this._logicalTypeName,this._export(e)),e},re.prototype._skip=function(e){this.underlyingType._skip(e)},re.prototype._export=function(){},re.prototype._fromValue=o.abstractFunction,re.prototype._toValue=o.abstractFunction,re.prototype._resolve=o.abstractFunction;function ie(e){this._concreteTypeName="long",w.call(this,!0),this._noUnpack=!!e}g.inherits(ie,m),ie.prototype.typeName="abstract:long",ie.prototype._check=function(e,t,r){var i=this._isValid(e);return!i&&r&&r(e,this),i},ie.prototype._read=function(e){var t,r;if(this._noUnpack?(r=e.pos,e.skipLong(),t=e.buf.slice(r,e.pos)):t=e.unpackLongBytes(e),e.isValid())return this._fromBuffer(t)},ie.prototype._write=function(e,t){this._isValid(t)||X(t,this);var r=this._toBuffer(t);this._noUnpack?e.writeFixed(r):e.packLongBytes(r)},ie.prototype._deref=function(){return"long"},ie.prototype._update=function(e,t){var r=this;switch(t.typeName){case"int":e._read=function(i){return r._fromJSON(t._read(i))};break;case"abstract:long":case"long":e._read=function(i){return r._read(i)}}},ie.prototype._fromBuffer=o.abstractFunction,ie.prototype._toBuffer=o.abstractFunction,ie.prototype._fromJSON=o.abstractFunction,ie.prototype._toJSON=o.abstractFunction,ie.prototype._isValid=o.abstractFunction,ie.prototype.compare=o.abstractFunction;function Fe(e,t,r){var i=e.name;if(typeof i!="string"||!Te(i))throw new Error(l("invalid field name: %s",i));this.name=i,this.type=s.forSchema(e.type,t,r.child(i)),this.aliases=e.aliases||[],this.doc=e.doc!==void 0?""+e.doc:void 0,this._order=function(E){switch(E){case"ascending":return 1;case"descending":return-1;case"ignore":return 0;default:throw new Error(l("invalid order: %j",E))}}(e.order===void 0?"ascending":e.order),this._defaultValue=e.default;var c=this._defaultValue;if(c!==void 0){var h=this.type;try{var y=p.fromDefaultJSON(c,h)}catch(E){throw new Error(l("bad default in field %s: %s",i,E))}me(h.typeName)&&h.typeName!=="bytes"?this.defaultValue=function(){return y}:this.defaultValue=function(){return p.fromDefaultJSON(c,h)}}Object.freeze(this)}Fe.prototype.defaultValue=function(){},Object.defineProperty(Fe.prototype,"order",{enumerable:!0,get:function(){return["descending","ignore","ascending"][this._order+1]}});function Ke(e,t){this._writerType=e,this._readerType=t,this._read=null,this.itemsType=null,this.size=0,this.symbols=null,this.valuesType=null}Ke.prototype._peek=s.prototype._peek;function se(e,t){this.namespace=e,this.path=t||[]}se.forOptions=function(e){return new se(e?e.namespace:void 0)},se.prototype.clone=function(){return new se(this.namespace,this.path)},se.prototype.child=function(e){return new se(this.namespace,this.path.concat(""+e))};function Je(e,t,r,i){if(r){if(r._readerType!==e)throw new Error("invalid resolver");return r._read(t,i)}else return e._read(t)}function We(e,t){~e.indexOf(".")?e=e.replace(/^\./,""):t&&(e=t+"."+e),e.split(".").forEach(function(i){if(!Te(i))throw new Error(l("invalid name: %j",e))});var r=o.unqualifyName(e);return me(r)?r:e}function Ne(e){var t={};e.name&&(t[e.name]=!0);var r=e.aliases,i,c;for(i=0,c=r.length;i<c;i++)t[r[i]]=!0;return Object.keys(t)}function me(e){var t=T[e];return t&&t.prototype instanceof w}function Qe(e){if(e==="error")e="record";else{var t=/^([^:]+):(.*)$/.exec(e);t&&(t[1]==="union"?e=t[2]+"Union":e=t[1])}return o.capitalize(e)+"Type"}function Pe(e){var t=e.readLong();return t<0&&(t=-t,e.skipLong()),t}function Be(e){return e>=-9007199254740990&&e<=9007199254740990}function Te(e){return F.test(e)}function X(e,t){throw new Error(l("invalid %j: %j",t.schema(),e))}function Ue(e,t){var r=o.unqualifyName(e);return me(r)?r:We(e,t)}function $e(e){var t=e.typeName;switch(t){case"double":case"float":case"int":case"long":return"number";case"bytes":case"fixed":return"buffer";case"enum":return"string";case"map":case"error":case"record":return"object";default:return t}}function Xe(e){if(e===null)return"null";var t=typeof e;if(t==="object"){if(Array.isArray(e))return"array";if(Buffer.isBuffer(e))return"buffer"}return t}function wt(e){var t={},r,i,c,h;for(r=0,i=e.length;r<i;r++)if(h=e[r],!o.isType(h,"logical")){if(c=$e(h),t[c])return!0;t[c]=!0}return!1}function bt(e){var t=["int","long","float","double"],r=-1,i=null,c,h,y,E;for(c=0,h=e.length;c<h;c++)y=e[c],E=t.indexOf(y.typeName),E>r&&(r=E,i=y);return i}function Et(e,t,r){var i={},c,h,y,E;for(c=0,h=e.length;c<h;c++){if(y=e[c],y.typeName==="string")return y;E=y.symbols;var N,A;for(N=0,A=E.length;N<A;N++)i[E[N]]=!0}return s.forSchema({type:"enum",symbols:Object.keys(i)},t,r)}function Ot(e,t,r){var i=-1,c,h,y;for(c=0,h=e.length;c<h;c++){if(y=e[c],y.typeName==="bytes")return y;i===-1?i=y.size:y.size!==i&&(i=-2)}return i<0?s.forSchema("bytes",t,r):e[0]}function Tt(e,t,r){var i=[],c={},h={},y=!0,E,N,A,U;for(E=0,N=e.length;E<N;E++)if(A=e[E],A.typeName==="map")y=!1,i.push(A.valuesType);else{U=A.fields;var q,z,P,j,D,le;for(q=0,z=U.length;q<z;q++)P=U[q],D=P.name,le=P.type,i.push(le),y&&(c[D]||(c[D]=[]),c[D].push(le),j=P.defaultValue(),j!==void 0&&(h[D]=j))}if(y){var ue=Object.keys(c);for(E=0,N=ue.length;E<N;E++)D=ue[E],c[D].length<e.length&&h[D]===void 0&&(t&&t.strictDefaults?y=!1:(c[D].unshift(s.forSchema("null",t,r.child(D))),h[D]=null))}var ce;return y?ce={type:"record",fields:ue.map(function(J){var fe=r.child(J),_e=s.forTypes(c[J],t,fe),Ie=h[J];if(Ie!==void 0&&~_e.typeName.indexOf("union")){var pe=_e.types.slice(),H,xe;for(H=0,xe=pe.length;H<xe&&!pe[H].isValid(Ie);H++);if(H>0){var Rt=pe[0];pe[0]=pe[H],pe[H]=Rt,_e=s.forSchema(pe,t,fe)}}return{name:J,type:_e,default:h[J]}})}:ce={type:"map",values:s.forTypes(i,t,r.child("*"))},s.forSchema(ce,t,r)}u.exports={constructors:function(){var e={Type:s,LogicalType:re,UnwrappedUnionType:M,WrappedUnionType:Q},t=Object.keys(T),r,i,c;for(r=0,i=t.length;r<i;r++)c=t[r],e[Qe(c)]=T[c];return e}(),getTypeBucket:$e,getValueBucket:Xe,isPrimitive:me,isValidName:Te,qualifyName:We}}}),Ct=De({"node_modules/@avro/types/lib/index.js"(n,u){"use strict";u.exports=Lt().constructors}}),Ye="AWS4-HMAC-SHA256",Ve="aws4_request",Me="s3",Dt="2",ne="UNSIGNED-PAYLOAD",Ft="application/octet-stream",Ze="application/xml",ge="application/json",Pt=["accessKeyId","secretAccessKey","sessionToken","password"],oe="x-amz-content-sha256",Bt="x-amz-date",Ut="host",Vt="Authorization",he="Content-Type",we="Content-Length",et="etag",tt="last-modified",L="ultralight-s3 Module: ",Mt=`${L}accessKeyId must be a non-empty string`,zt=`${L}secretAccessKey must be a non-empty string`,qt=`${L}endpoint must be a non-empty string`,Ht=`${L}bucketName must be a non-empty string`,rt=`${L}key must be a non-empty string`,be=`${L}uploadId must be a non-empty string`,it=`${L}parts must be a non-empty array`,nt=`${L}Each part must have a partNumber (number) and ETag (string)`,je=`${L}data must be a Buffer or string`,ot=`${L}prefix must be a string`,st=`${L}maxKeys must be a positive integer`,at=`${L}delimiter must be a string`,pt=crypto.createHmac||(await import("node:crypto")).createHmac,dt=crypto.createHash||(await import("node:crypto")).createHash;typeof pt>"u"&&typeof dt>"u"&&console.error("ultralight-S3 Module: Crypto functions are not available, please report the issue with necessary description: https://github.com/sentienhq/ultralight-s3/issues");var Gt={contents:!0},Kt=n=>`%${n.charCodeAt(0).toString(16).toUpperCase()}`,He=n=>encodeURIComponent(n).replace(/[!'()*]/g,Kt),ae=n=>He(n).replace(/%2F/g,"/"),Jt=class{constructor({accessKeyId:n,secretAccessKey:u,endpoint:o,bucketName:p,region:d="auto",maxRequestSizeInBytes:g=5242880,requestAbortTimeout:b=void 0,logger:O=void 0}){this.getBucketName=()=>this.bucketName,this.setBucketName=l=>{this.bucketName=l},this.getRegion=()=>this.region,this.setRegion=l=>{this.region=l},this.getEndpoint=()=>this.endpoint,this.setEndpoint=l=>{this.endpoint=l},this.getMaxRequestSizeInBytes=()=>this.maxRequestSizeInBytes,this.setMaxRequestSizeInBytes=l=>{this.maxRequestSizeInBytes=l},this.sanitizeETag=l=>Se(l),this.getProps=()=>({accessKeyId:this.accessKeyId,secretAccessKey:this.secretAccessKey,region:this.region,bucket:this.bucketName,endpoint:this.endpoint,maxRequestSizeInBytes:this.maxRequestSizeInBytes,requestAbortTimeout:this.requestAbortTimeout,logger:this.logger}),this.setProps=l=>{this._validateConstructorParams(l.accessKeyId,l.secretAccessKey,l.bucketName,l.endpoint),this.accessKeyId=l.accessKeyId,this.secretAccessKey=l.secretAccessKey,this.region=l.region||"auto",this.bucketName=l.bucketName,this.endpoint=l.endpoint,this.maxRequestSizeInBytes=l.maxRequestSizeInBytes||5242880,this.requestAbortTimeout=l.requestAbortTimeout,this.logger=l.logger},this._validateConstructorParams(n,u,o,p),this.accessKeyId=n,this.secretAccessKey=u,this.endpoint=o,this.bucketName=p,this.region=d,this.maxRequestSizeInBytes=g,this.requestAbortTimeout=b,this.logger=O}_validateConstructorParams(n,u,o,p){if(typeof n!="string"||n.trim().length===0)throw new TypeError(Mt);if(typeof u!="string"||u.trim().length===0)throw new TypeError(zt);if(typeof o!="string"||o.trim().length===0)throw new TypeError(qt);if(typeof p!="string"||p.trim().length===0)throw new TypeError(Ht)}_checkMethodHeadnGet(n){if(n!=="GET"&&n!=="HEAD")throw this._log("error",`${L}method must be either GET or HEAD`),new Error("method must be either GET or HEAD")}_checkKey(n){if(typeof n!="string"||n.trim().length===0)throw this._log("error",rt),new TypeError(rt)}_checkDelimiter(n){if(typeof n!="string"||n.trim().length===0)throw this._log("error",at),new TypeError(at)}_checkPrefix(n){if(typeof n!="string")throw this._log("error",ot),new TypeError(ot)}_checkMaxKeys(n){if(typeof n!="number"||n<=0)throw this._log("error",st),new TypeError(st)}_checkOpts(n){if(typeof n!="object")throw this._log("error",`${L}opts must be an object`),new TypeError(`${L}opts must be an object`)}_log(n,u,o={}){if(this.logger&&typeof this.logger[n]=="function"){let p=b=>typeof b!="object"||b===null?b:Object.keys(b).reduce((O,l)=>(Pt.includes(l.toLowerCase())?O[l]="[REDACTED]":typeof b[l]=="object"&&b[l]!==null?O[l]=p(b[l]):O[l]=b[l],O),Array.isArray(b)?[]:{}),d=p(o),g={timestamp:new Date().toISOString(),level:n,message:u,...d,context:p({bucketName:this.bucketName,region:this.region,endpoint:this.endpoint,accessKeyId:this.accessKeyId?`${this.accessKeyId.substring(0,4)}...`:void 0})};this.logger[n](g)}}async getContentLength(n){this._checkKey(n);let u={[oe]:ne},o=ae(n),{url:p,headers:d}=await this._sign("HEAD",o,{},u,""),g=(await this._sendRequest(p,"HEAD",d)).headers.get(we);return g?parseInt(g,10):0}async bucketExists(){let n={[oe]:ne},{url:u,headers:o}=await this._sign("HEAD","",{},n,""),p=await this._sendRequest(u,"HEAD",o);return!!(p.ok&&p.status===200)}async fileExists(n,u={}){this._checkKey(n);let{filteredOpts:o,conditionalHeaders:p}=this._filterIfHeaders(u),d={[oe]:ne,...p},g=ae(n),{url:b,headers:O}=await this._sign("HEAD",g,o,d,"");try{let l=await this._sendRequest(b,"HEAD",O,"",[200,404,412,304]);return l.status===404?!1:l.status===412||l.status===304?null:l.ok&&l.status===200?!0:(this._handleErrorResponse(l),!1)}catch(l){let T=l instanceof Error?l.message:String(l);throw this._log("error",`${L}Failed to check if file exists: ${T}`),new Error(`${L}Failed to check if file exists: ${T}`)}}async _sign(n,u,o,p,d){let g=new Date().toISOString().replace(/[:-]|\.\d{3}/g,""),b=typeof u=="string"&&u.length>0?new URL(u,this.endpoint):new URL(this.endpoint);b.pathname=`/${encodeURI(this.bucketName)}${b.pathname}`,p[oe]=d?await Le(d):ne,p[Bt]=g,p[Ut]=b.host;let O=this._buildCanonicalHeaders(p),l=Object.keys(p).map(v=>v.toLowerCase()).sort().join(";"),T=await this._buildCanonicalRequest(n,b,o,O,l,d),F=await this._buildStringToSign(g,T),x=await this._calculateSignature(g,F),V=this._buildAuthorizationHeader(g,l,x);return p[Vt]=V,{url:b.toString(),headers:p}}_buildCanonicalHeaders(n){return Object.entries(n).map(([u,o])=>`${u.toLowerCase()}:${String(o).trim()}`).sort().join(`
`)}async _buildCanonicalRequest(n,u,o,p,d,g){return[n,u.pathname,this._buildCanonicalQueryString(o),`${p}
`,d,g?await Le(g):ne].join(`
`)}async _buildStringToSign(n,u){let o=[n.slice(0,8),this.region,Me,Ve].join("/");return[Ye,n,o,await Le(u)].join(`
`)}async _calculateSignature(n,u){let o=await this._getSignatureKey(n.slice(0,8));return Re(o,u,"hex")}_buildAuthorizationHeader(n,u,o){let p=[n.slice(0,8),this.region,Me,Ve].join("/");return[`${Ye} Credential=${this.accessKeyId}/${p}`,`SignedHeaders=${u}`,`Signature=${o}`].join(", ")}_filterIfHeaders(n){let u={},o={},p=["if-match","if-none-match","if-modified-since","if-unmodified-since"];for(let[d,g]of Object.entries(n))p.includes(d)?o[d]=g:u[d]=g;return{filteredOpts:u,conditionalHeaders:o}}async list(n="/",u="",o=1e3,p="GET",d={}){this._checkDelimiter(n),this._checkPrefix(u),this._checkMaxKeys(o),this._checkMethodHeadnGet(p),this._checkOpts(d),this._log("info",`Listing objects in ${u}`);let g={"list-type":Dt,"max-keys":String(o),...d};u.length>0&&(g.prefix=u);let b={[he]:ge,[oe]:ne},O=n==="/"?n:He(n),{url:l,headers:T}=await this._sign("GET",O,g,b,""),F=`${l}?${new URLSearchParams(g)}`,x=await this._sendRequest(F,"GET",T),V=await x.text();if(p==="HEAD"){let w=x.headers.get(we),a=x.headers.get(tt),f=x.headers.get(et);return{size:w?+w:void 0,mtime:a?new Date(a):void 0,ETag:f||void 0}}let v=Ee(V),s=v.listBucketResult||v.error||v;return s.contents||s}async listMultiPartUploads(n="/",u="",o="GET",p={}){var d,g,b;this._checkDelimiter(n),this._checkPrefix(u),this._checkMethodHeadnGet(o),this._checkOpts(p),this._log("info",`Listing multipart uploads in ${u}`);let O={uploads:"",...p},l={[he]:ge,[oe]:ne},T=n==="/"?n:He(n),{url:F,headers:x}=await this._sign("GET",T,O,l,""),V=`${F}?${new URLSearchParams(O)}`,v=await this._sendRequest(V,"GET",x),s=await v.text();if(o==="HEAD")return{size:+((d=v.headers.get(we))!==null&&d!==void 0?d:"0"),mtime:new Date((g=v.headers.get(tt))!==null&&g!==void 0?g:""),ETag:(b=v.headers.get(et))!==null&&b!==void 0?b:""};let w=Ee(s),a=w.listMultipartUploadsResult||w.error||w;return a.uploads||a}async get(n,u={}){this._checkKey(n),this._log("info",`Getting object ${n}`);let{filteredOpts:o,conditionalHeaders:p}=this._filterIfHeaders(u),d={[he]:ge,[oe]:ne,...p},g=ae(n),{url:b,headers:O}=await this._sign("GET",g,o,d,""),l=await this._sendRequest(b,"GET",O,"",[200,404,412,304]);if(l.status===404||l.status===412||l.status===304)return this._log("error",`Failed to get object. Status: ${l.status}`),null;if(!l.ok)throw this._log("error",`Failed to get object. Status: ${l.status}`),new Error(`Failed to get object. Status: ${l.status}`);return l.text()}async getObjectWithETag(n,u={}){this._checkKey(n),this._log("info",`Getting object ${n}`);let{filteredOpts:o,conditionalHeaders:p}=this._filterIfHeaders(u),d={[he]:ge,[oe]:ne,...p},g=ae(n),{url:b,headers:O}=await this._sign("GET",g,o,d,"");try{let l=await this._sendRequest(b,"GET",O,"",[200,404,412,304]);if(l.status===404||l.status===412||l.status===304)return this._log("error",`Failed to get object. Status: ${l.status}`),{etag:null,data:null};if(!l.ok)throw this._log("error",`Failed to get object. Status: ${l.status}`),new Error(`Failed to get object. Status: ${l.status}`);let T=l.headers.get("etag");if(!T)throw new Error("ETag not found in response headers");let F=await l.text();return{etag:Se(T),data:F}}catch(l){throw this._log("error",`Error getting object ${n} with ETag: ${l}`),l}}async getEtag(n,u={}){this._checkKey(n),this._log("info",`Getting etag object ${n}`);let{filteredOpts:o,conditionalHeaders:p}=this._filterIfHeaders(u),d={[he]:ge,[oe]:ne,...p},g=ae(n),{url:b,headers:O}=await this._sign("HEAD",g,o,d,""),l=await this._sendRequest(b,"HEAD",O,"",[200,412,304]);if(this._log("info",`Response status: ${l.status,l.statusText}`),l.status===412||l.status===304)return null;let T=l.headers.get("etag");if(!T)throw this._log("error","ETag not found in response headers"),new Error("ETag not found in response headers");return Se(T)}async getResponse(n,u=!0,o=0,p=this.maxRequestSizeInBytes,d={}){this._checkKey(n);let{filteredOpts:g,conditionalHeaders:b}=this._filterIfHeaders({...d}),O={[he]:ge,[oe]:ne,...u?{}:{range:`bytes=${o}-${p-1}`},...b},l=ae(n),{url:T,headers:F}=await this._sign("GET",l,g,O,""),x=`${T}?${new URLSearchParams(g)}`;return this._sendRequest(x,"GET",F)}async put(n,u){if(this._checkKey(n),!(u instanceof Buffer||typeof u=="string"))throw this._log("error",je),new TypeError(je);this._log("info",`Uploading object ${n}`);let o=typeof u=="string"?Buffer.byteLength(u):u.length,p={[we]:o},d=ae(n),{url:g,headers:b}=await this._sign("PUT",d,{},p,u);return await this._sendRequest(g,"PUT",b,u)}async getMultipartUploadId(n,u=Ft){if(this._checkKey(n),typeof u!="string")throw this._log("error",`${L}fileType must be a string`),new TypeError(`${L}fileType must be a string`);this._log("info",`Initiating multipart upload for object ${n}`);let o={uploads:""},p={[he]:u,[oe]:ne},d=ae(n),{url:g,headers:b}=await this._sign("POST",d,o,p,""),O=`${g}?${new URLSearchParams(o)}`,l=await(await this._sendRequest(O,"POST",b)).text(),T=Ee(l);if(typeof T=="object"&&T!==null&&"error"in T&&typeof T.error=="object"&&T.error!==null&&"message"in T.error){let F=String(T.error.message);throw this._log("error",`${L}Failed to abort multipart upload: ${F}`),new Error(`${L}Failed to abort multipart upload: ${F}`)}if(typeof T=="object"&&T!==null){if(!T.initiateMultipartUploadResult||!T.initiateMultipartUploadResult.uploadId)throw this._log("error",`${L}Failed to create multipart upload: no uploadId in response`),new Error(`${L}Failed to create multipart upload: Missing upload ID in response`);return T.initiateMultipartUploadResult.uploadId}else throw this._log("error",`${L}Failed to create multipart upload: unexpected response format`),new Error(`${L}Failed to create multipart upload: Unexpected response format`)}async uploadPart(n,u,o,p,d={}){this._validateUploadPartParams(n,u,o,p,d);let g={uploadId:o,partNumber:p,...d},b={[we]:u.length},O=ae(n),{url:l,headers:T}=await this._sign("PUT",O,g,b,u),F=`${l}?${new URLSearchParams(g)}`,x=await this._sendRequest(F,"PUT",T,u),V=Se(x.headers.get("etag")||"");return{partNumber:p,ETag:V}}_validateUploadPartParams(n,u,o,p,d){if(this._checkKey(n),!(u instanceof Buffer||typeof u=="string"))throw this._log("error",je),new TypeError(je);if(typeof o!="string"||o.trim().length===0)throw this._log("error",be),new TypeError(be);if(!Number.isInteger(p)||p<=0)throw this._log("error",`${L}partNumber must be a positive integer`),new TypeError(`${L}partNumber must be a positive integer`);this._checkOpts(d)}async completeMultipartUpload(n,u,o){if(this._checkKey(n),typeof u!="string"||u.trim().length===0)throw this._log("error",be),new TypeError(be);if(!Array.isArray(o)||o.length===0)throw this._log("error",it),new TypeError(it);if(!o.every(V=>typeof V.partNumber=="number"&&typeof V.ETag=="string"))throw this._log("error",nt),new TypeError(nt);this._log("info",`Complete multipart upload ${u} for object ${n}`);let p={uploadId:u},d=this._buildCompleteMultipartUploadXml(o),g={[he]:Ze,[we]:Buffer.byteLength(d).toString(),[oe]:await Le(d)},b=ae(n),{url:O,headers:l}=await this._sign("POST",b,p,g,d),T=`${O}?${new URLSearchParams(p)}`,F=await(await this._sendRequest(T,"POST",l,d)).text(),x=Ee(F);if(typeof x=="object"&&x!==null&&"error"in x&&typeof x.error=="object"&&x.error!==null&&"message"in x.error){let V=String(x.error.message);throw this._log("error",`${L}Failed to abort multipart upload: ${V}`),new Error(`${L}Failed to abort multipart upload: ${V}`)}return x.completeMultipartUploadResult}async abortMultipartUpload(n,u){if(this._checkKey(n),typeof u!="string"||u.trim().length===0)throw this._log("error",be),new TypeError(be);this._log("info",`Aborting multipart upload ${u} for object ${n}`);let o={uploadId:u},p={[he]:Ze,[oe]:ne};try{let d=ae(n),{url:g,headers:b}=await this._sign("DELETE",d,o,p,""),O=`${g}?${new URLSearchParams(o)}`,l=await this._sendRequest(O,"DELETE",b);if(l.ok){let T=await l.text(),F=Ee(T);if(typeof F=="object"&&F!==null&&"error"in F&&typeof F.error=="object"&&F.error!==null&&"message"in F.error){let x=String(F.error.message);throw this._log("error",`${L}Failed to abort multipart upload: ${x}`),new Error(`${L}Failed to abort multipart upload: ${x}`)}return{status:"Aborted",key:n,uploadId:u,response:F}}else throw this._log("error",`${L}Abort request failed with status ${l.status}`),new Error(`${L}Abort request failed with status ${l.status}`)}catch(d){let g=d instanceof Error?d.message:String(d);throw this._log("error",`${L}Failed to abort multipart upload for key ${n}: ${g}`),new Error(`${L}Failed to abort multipart upload for key ${n}: ${g}`)}}_buildCompleteMultipartUploadXml(n){return`
      <CompleteMultipartUpload>
        ${n.map(u=>`
          <Part>
            <PartNumber>${u.partNumber}</PartNumber>
            <ETag>${u.ETag}</ETag>
          </Part>
        `).join("")}
      </CompleteMultipartUpload>
    `}async delete(n){this._checkKey(n),this._log("info",`Deleting object ${n}`);let u={[he]:ge,[oe]:ne},o=ae(n),{url:p,headers:d}=await this._sign("DELETE",o,{},u,""),g=await this._sendRequest(p,"DELETE",d);return g.status===204||g.status===200}async _sendRequest(n,u,o,p,d=[]){this._log("info",`Sending ${u} request to ${n}, headers: ${JSON.stringify(o)}`);let g=await fetch(n,{method:u,headers:o,body:["GET","HEAD"].includes(u)?void 0:p,signal:this.requestAbortTimeout!==void 0?AbortSignal.timeout(this.requestAbortTimeout):void 0});return!g.ok&&!d.includes(g.status)&&await this._handleErrorResponse(g),g}async _handleErrorResponse(n){let u=await n.text(),o=n.headers.get("x-amz-error-code")||"Unknown",p=n.headers.get("x-amz-error-message")||n.statusText;throw this._log("error",`${L}Request failed with status ${n.status}: ${o} - ${p},err body: ${u}`),new Error(`${L}Request failed with status ${n.status}: ${o} - ${p}, err body: ${u}`)}_buildCanonicalQueryString(n){return Object.keys(n).length<1?"":Object.keys(n).sort().map(u=>`${encodeURIComponent(u)}=${encodeURIComponent(n[u])}`).join("&")}async _getSignatureKey(n){let u=await Re(`AWS4${this.secretAccessKey}`,n),o=await Re(u,this.region),p=await Re(o,Me);return Re(p,Ve)}},Le=async n=>{let u=dt("sha256");return u.update(n),u.digest("hex")},Re=async(n,u,o)=>{let p=pt("sha256",n);return p.update(u),p.digest(o)},Se=n=>{let u={'"':"","&quot;":"","&#34;":"","&QUOT;":"","&#x00022":""};return n.replace(/^("|&quot;|&#34;)|("|&quot;|&#34;)$/g,o=>u[o])},Ee=n=>{let u=g=>g.replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),o={},p=/<(\w)([-\w]+)(?:\/|[^>]*>((?:(?!<\1)[\s\S])*)<\/\1\2)>/gm,d;for(;d=p.exec(n);){let[,g,b,O]=d,l=g.toLowerCase()+b,T=O!=null?Ee(O):!0;typeof T=="string"?o[l]=Se(u(T)):Array.isArray(o[l])?o[l].push(T):o[l]=o[l]!=null?[o[l],T]:Gt[l]?[T]:T}return Object.keys(o).length?o:u(n)},yt=xt(Ct(),1),k={MISSING_ARGUMENT:"MISSING_ARGUMENT",COLLECTION_EXISTS:"COLLECTION_EXISTS",CREATE_COLLECTION_ERROR:"CREATE_COLLECTION_ERROR",RENAME_COLLECTION_ERROR:"RENAME_COLLECTION_ERROR",REMOVE_COLLECTION_ERROR:"REMOVE_COLLECTION_ERROR",UPDATE_COLLECTION_SCHEMA_ERROR:"UPDATE_COLLECTION_SCHEMA_ERROR",COLLECTION_NOT_FOUND:"COLLECTION_NOT_FOUND",SCHEMA_VALIDATION_ERROR:"SCHEMA_VALIDATION_ERROR",DOCUMENT_VALIDATION_ERROR:"DOCUMENT_VALIDATION_ERROR",S3_OPERATION_ERROR:"S3_OPERATION_ERROR",FIND_ERROR:"FIND_ERROR",FIND_ONE_ERROR:"FIND_ONE_ERROR",SAVE_DATA_ERROR:"SAVE_DATA_ERROR",INSERT_ERROR:"INSERT_ERROR",UPDATE_ERROR:"UPDATE_ERROR",UPDATE_ONE_ERROR:"UPDATE_ONE_ERROR",DELETE_ERROR:"DELETE_ERROR",COUNT_ERROR:"COUNT_ERROR",UNKNOWN_ERROR:"UNKNOWN_ERROR"},C=class extends Error{constructor(n,u=k.UNKNOWN_ERROR){super(`lowstorageError: ${n} :: code: ${u}`),this.name=this.constructor.name,this.code=u,Error.captureStackTrace(this,this.constructor)}},ve=class extends C{constructor(n,u=k.SCHEMA_VALIDATION_ERROR){super(n,u),super(n,k.SCHEMA_VALIDATION_ERROR)}},Oe=class extends C{constructor(n,u=k.DOCUMENT_VALIDATION_ERROR){super(n,u),super(n,k.DOCUMENT_VALIDATION_ERROR)}},te=class extends C{constructor(n,u){super(`S3 ${u} operation failed: ${n}`,k.S3_OPERATION_ERROR)}},Ce=(n,u)=>Object.keys(u).every(o=>n[o]===u[o]),Wt=async()=>typeof ze<"u"&&typeof ze=="function"?ze():typeof crypto<"u"&&typeof crypto=="object"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var u=Math.random()*16|0,o=n==="x"?u:u&3|8;return o.toString(16)}),_t=(n,u="SubAutoGenerated")=>{switch(typeof n){case"string":return Qt(n)?{type:"string",name:"_id",size:16,logicalType:"UUID"}:"string";case"number":return Number.isInteger(n)?"int":"float";case"boolean":return"boolean";case"object":return n===null?"null":Array.isArray(n)?{type:"array",items:_t(n[0])}:gt(n,u);default:return"string"}},Ae=n=>{let u={name:"_id",type:"string",size:16,logicalType:"UUID"};return typeof n>"u"||n===null||("type"in n&&n.type==="record"&&"fields"in n&&Array.isArray(n.fields)?n.fields.some(p=>p.name==="_id")||n.fields.unshift(u):"type"in n&&n.type==="array"&&"items"in n&&n.items!==null&&typeof n.items=="object"&&"type"in n.items&&n.items.type==="record"&&"fields"in n.items&&Array.isArray(n.items.fields)&&(n.items.fields.some(p=>p.name==="_id")||n.items.fields.unshift(u))),n},gt=(n,u="AutoGenerated")=>{Array.isArray(n)&&(n=n[0]);let o=Object.entries(n).map(([d,g])=>({name:d,type:_t(g,`${u}.${d}`)}));return Ae({type:"record",name:u,fields:o})},Qt=n=>/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i.test(n),I="lowstorage",de="/",vt="lowstorage",ye=".avro",Xt=1024*1024,ut=5*Xt,Ge=Buffer.from("","utf8"),qe=(n=k.DOCUMENT_VALIDATION_ERROR)=>{throw new Oe(`${I}: Invalid document or schema ${n}`)},ke=(n="")=>{if(n.trim()===""||n===null||typeof n>"u"||n.length>255||n===null)throw new C(`${I}: Collection name is required, null or too long`,k.MISSING_ARGUMENT)},nr=class{constructor(n){this._checkArgs=u=>{let o=["accessKeyId","secretAccessKey","endpoint","bucketName"];for(let p of o)if(!u[p])throw new C(`${I}: ${p} is required`,k.MISSING_ARGUMENT)},this.s3=()=>this._s3,this._checkArgs(n),this._schemas=new Map,this._s3=new Jt(n),this._dirPrefix=n.dirPrefix||vt,this._avroParse=yt.Type}async listCollections(){try{let n=await this._s3.list(de,this._dirPrefix);return Array.isArray(n)?n.map(u=>u.key.slice(this._dirPrefix.length+1,-ye.length)):typeof n=="object"&&n!==null&&"keyCount"in n&&n.keyCount==="0"?[]:[]}catch(n){throw new te(`${I}: ${n.message}`,k.S3_OPERATION_ERROR)}}async collectionExists(n=""){try{return ke(n),!!await this._s3.fileExists(`${this._dirPrefix}${de}${n}${ye}`)}catch(u){if(u.message.includes("Not Found"))return!1;throw new C(`${I}: ${u.message}`,k.COLLECTION_NOT_FOUND)}}async createCollection(n="",u,o=[]){try{if(ke(n),!await this.collectionExists(n)){if(typeof u<"u"&&u!==null)try{if(!this._avroParse.isValid(u))throw new ve(`${I}: Schema is invalid: ${u} ${k.SCHEMA_VALIDATION_ERROR}`)}catch{throw new ve(`${I}: Schema is invalid: ${u}`,k.SCHEMA_VALIDATION_ERROR)}if(o.length>0&&u){let d=this._avroParse.forSchema({type:"array",items:u});await this._s3.put(`${this._dirPrefix}${de}${n}${ye}`,d.toBuffer(o))}else await this._s3.put(`${this._dirPrefix}${de}${n}${ye}`,Ge);return this.collection(n,u,!1)}throw new C(`${I}: Collection ${n} already exists`,k.COLLECTION_EXISTS)}catch(p){throw p instanceof C?p:new C(`${I}: ${p.message}`,k.CREATE_COLLECTION_ERROR)}}async removeCollection(n=""){try{if(ke(n),await this.collectionExists(n)){await this._s3.delete(`${this._dirPrefix}${de}${n}${ye}`);let o=await this.collectionExists(n);if(typeof o=="boolean"){if(!o)return this._schemas.delete(n),!0;throw new C(`${I}: Failed to delete collection ${n}`,k.S3_OPERATION_ERROR)}throw new te(`${I}: Failed to delete collection ${n}`,k.S3_OPERATION_ERROR)}throw new C(`${I}: Collection ${n} does not exist`,k.REMOVE_COLLECTION_ERROR)}catch(u){throw u instanceof te?u:new C(`${I}: Failed to remove collection: ${u.message}`,k.REMOVE_COLLECTION_ERROR)}}async collection(n="",u,o=!0){try{ke(n);let p=`${this._dirPrefix}${de}${n}${ye}`;if(!await this._s3.fileExists(p)){if(!o)throw new C(`${I}: Collection ${n} does not exist`,k.COLLECTION_NOT_FOUND);await this._s3.put(p,Ge)}let g=u||this._schemas.get(n)||void 0;return new Yt(n,g,this._s3,this._dirPrefix)}catch(p){throw p.message.includes("unknown type")?new ve(`${I}: Schema input is invalid: ${p.message}`,k.SCHEMA_VALIDATION_ERROR):new C(`${I}: ${p.message}`,k.COLLECTION_NOT_FOUND)}}},Yt=class mt{constructor(u="",o,p,d=vt,g=!1,b=ut){this.getProps=()=>({colName:this._colName,s3:this._s3,schema:this._schema,avroParse:this._avroParse,avroType:this._avroType,dirPrefix:this._dirPrefix,safeWrite:this._safeWrite,chunkSize:this._chunkSize}),this.setProps=O=>{this._colName=O.colName,this._schema=O.schema,this._s3=O.s3,this._avroParse=O.avroParse,this._avroType=O.avroType,this._dirPrefix=O.dirPrefix,this._safeWrite=O.safeWrite,this._chunkSize=O.chunkSize},this.setSafeWrite=O=>{this._safeWrite=O},this.getSafeWrite=()=>this._safeWrite,this.getAvroSchema=()=>this._schema,this.setAvroSchema=O=>{this._schema=Ae(O),this._avroType=typeof O>"u"?null:this._avroParse.forSchema(O)},this._colName=u.trim(),this._s3=p,this._schema=Ae(o),this._dirPrefix=d,this._safeWrite=g,this._chunkSize=b||ut,this._s3.setMaxRequestSizeInBytes(this._chunkSize),this._avroParse=yt.Type,this._lastETag="",this._dataCache=[],this._avroType=typeof o>"u"?null:this._avroParse.ForSchema(o),this._key=`${this._dirPrefix}${de}${this._colName}${ye}`}async _loadData(){try{if(this._avroType===null||typeof this._avroType>"u")throw new C(`${I}: Missing type definition. Configure before operations `,k.SCHEMA_VALIDATION_ERROR);let{etag:u,data:o}=await this._s3.getObjectWithETag(this._key,{"if-none-match":this._lastETag});if(o===null)return this._dataCache;this._lastETag=u===null?this._lastETag:u;let p=this._avroParse.forSchema({type:"array",items:this._avroType});if(o.length<this._chunkSize)return this._dataCache=o.length>0?p.fromBuffer(Buffer.from(o,"utf8")):[],this._dataCache;let d=this._chunkSize,g=[Buffer.from(o,"utf8")],b=!0;for(;b;){let l=await this._s3.getResponse(this._key,!1,d,d+this._chunkSize),T=await l.text();g.push(Buffer.from(T,"utf8")),d+=this._chunkSize,parseInt(l.headers.get("content-length")||T.length.toString())<this._chunkSize&&(b=!1)}let O=Buffer.concat(g);return this._dataCache=p.fromBuffer(O),this._dataCache}catch(u){if(u.toString().indexOf("status 404: Unknown - Not Found")>-1)return this._dataCache=[],this._dataCache;throw new te(`${I}: Failed to load data: ${u.message}`,k.S3_OPERATION_ERROR)}}async _saveData(u){try{if(this._avroType===null||typeof this._avroType>"u")throw new C(`${I}: Missing type definition. Configure before operations `,k.SCHEMA_VALIDATION_ERROR);let o=this._avroParse.forSchema({type:"array",items:this._avroType}),p=u.length>0?o.toBuffer(u):Ge;if(this._safeWrite&&this._lastETag!==""){let b=await this._s3.getEtag(this._key);if(b!==null&&b!==this._lastETag)return!1}let d=await this._s3.put(this._key,p);if(typeof d=="object"&&"status"in d&&d.status!==200)throw new te(`${I}: Failed to save data`,k.S3_OPERATION_ERROR);let g=d.headers?.get("etag")||"";return g&&g.length>0&&(this._lastETag=this._s3.sanitizeETag(g),this._dataCache=u),!0}catch(o){throw o instanceof te?o:new C(`${I}: ${o.message}`,k.SAVE_DATA_ERROR)}}async insert(u,o){try{if(u==null)throw new C(`${I}: Document is required for insert`,k.INSERT_ERROR);if(typeof u!="object"&&!Array.isArray(u))throw new Oe(`${I}: Document must be an object or an array`,k.DOCUMENT_VALIDATION_ERROR);let p=Array.isArray(u)?u:[u],d=o?Ae(o):this._schema||Ae(gt(p[0])),g=this._avroParse.forSchema(d);if(!g)throw new ve(`${I}: Schema is required - Pass a schema to the insert method`,k.SCHEMA_VALIDATION_ERROR);this._avroType=g;let b=await this._loadData();for(let l of p){if(typeof l!="object"||l===null)throw new Oe(`${I}: Invalid input: input must be an object or an array of objects`,k.DOCUMENT_VALIDATION_ERROR);if(l._id=l._id||await Wt(),this._avroType.isValid(l,{errorHook:qe,noUndeclaredFields:!0})===!0)b.push(l);else throw new Oe(`${I}: Invalid document or schema`,k.DOCUMENT_VALIDATION_ERROR)}if(!await this._saveData(b))throw new te(`${I}: Failed to insert document`,k.S3_OPERATION_ERROR);return this.setAvroSchema(d),p}catch(p){throw p.message.includes("unknown type")?new ve(`${I}: Schema input is invalid: ${p.message}`,k.SCHEMA_VALIDATION_ERROR):p instanceof C?p:new C(`${I} Insert operation failed: ${p.message}`,k.INSERT_ERROR)}}async find(u={},o={}){try{if(u==null)throw new C(`${I}: Query is required for update`,k.MISSING_ARGUMENT);let p=await this._loadData(),d=o.skip!==void 0?parseInt(String(o.skip),10):0,g=o.limit!==void 0?d+parseInt(String(o.limit),10):void 0;return p.filter(O=>Ce(O,u)).slice(d,g)}catch(p){throw new C(`${I}: Find operation failed: ${p.message}`,k.FIND_ERROR)}}async findOne(u={}){try{if(u===null)throw new C(`${I}: Query cannot be null`,k.INVALID_ARGUMENT);return(await this.find(u,{limit:1}))[0]||null}catch(o){throw o instanceof C?o:new C(`${I}: FindOne operation failed: ${o.message}`,k.FIND_ONE_ERROR)}}async update(u={},o={},p={}){try{if(u==null||o===void 0||o===null)throw new C(`${I}: Query and update values are required for update`,k.MISSING_ARGUMENT);if(!this._avroType)throw new ve(`${I}: Schema is not defined for this collection`,k.SCHEMA_VALIDATION_ERROR);let d=await this._loadData();if(d.length===0)return 0;let g=0;for(let b=0;b<d.length;b++)if(Ce(d[b],u)){let O={...d[b],...o};if(this._avroType.isValid(O,{errorHook:qe,noUndeclaredFields:!0})===!0)d[b]=O,g++;else throw new Oe(`${I}: Invalid document or schema`,k.DOCUMENT_VALIDATION_ERROR)}if(g>0){if(!await this._saveData(d))throw new te(`${I}: Failed to update document`,k.S3_OPERATION_ERROR)}else if(p&&"upsert"in p&&p.upsert){if(!await this.insert(o))throw new te(`${I}: Failed to update document`,k.S3_OPERATION_ERROR);g=1}return g}catch(d){throw d instanceof te?d:new C(`${I}: Update operation failed: ${d.message}`,k.UPDATE_ERROR)}}async updateOne(u={},o={},p={}){try{if(u==null||o===void 0||o===null)throw new C(`${I}: Query is required`,k.MISSING_ARGUMENT);if(!this._avroType)throw new ve(`${I}: Schema is not defined for this collection`,k.SCHEMA_VALIDATION_ERROR);let d=await this._loadData();if(d.length===0)return 0;let g=d.findIndex(b=>Ce(b,u));if(g!==-1){let b={...d[g],...o};if(this._avroType.isValid(b,{errorHook:qe,noUndeclaredFields:!0})===!0){if(d[g]=b,!await this._saveData(d))throw new te(`${I}: Failed to update document`,k.S3_OPERATION_ERROR);return 1}else throw new Oe(`${I}: Invalid document or schema`,k.DOCUMENT_VALIDATION_ERROR)}if(p&&"upsert"in p&&p.upsert){if(!await this.insert(o))throw new te(`${I}: Failed to update document`,k.S3_OPERATION_ERROR);return 1}return 0}catch(d){throw d instanceof C?d:new C(`${I}: UpdateOne operation failed: ${d.message}`,k.UPDATE_ONE_ERROR)}}async delete(u={}){try{if(u==null)throw new C(`${I}: Query is required`,k.MISSING_ARGUMENT);let o=await this._loadData();if(o.length===0)return 0;let p=o.length,d=o.filter(b=>!Ce(b,u));if(!await this._saveData(d))throw new te(`${I}: Failed to delete document`,k.S3_OPERATION_ERROR);return p-d.length}catch(o){throw o instanceof te?o:new C(`${I}: Delete operation failed: ${o.message}`,k.DELETE_ERROR)}}async deleteAll(){try{let o=(await this._loadData()).length;if(!await this._saveData([]))throw new te(`${I}: Failed to delete document`,k.S3_OPERATION_ERROR);return o}catch(u){throw u instanceof te?u:new C(`${I}: Delete operation failed: ${u.message}`,k.DELETE_ERROR)}}async count(u={}){try{return(await this.find(u)).length}catch(o){throw new C(`${I}: Count operation failed: ${o.message}`,k.COUNT_ERROR)}}async renameCollection(u,o=this._schema){try{if(ke(u),await this._s3.fileExists(`${this._dirPrefix}${de}${u}${ye}`))throw new C(`${I}: Collection ${u} already exists`,k.COLLECTION_EXISTS);let d=o||this.getAvroSchema(),g=await this._loadData(),b=new mt(u,d,this._s3,this._dirPrefix,this._safeWrite,this._chunkSize);return await b._saveData(g),await this._s3.delete(`${this._dirPrefix}${de}${this._colName}${ye}`),b}catch(p){throw p instanceof C?p:new C(`${I}: Rename collection failed: ${p.message}`,k.RENAME_COLLECTION_ERROR)}}};export{nr as lowstorage,C as lowstorageError,k as lowstorage_ERROR_CODES};
//# sourceMappingURL=lowstorage.js.map
